"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.setInitialForgeConfig = setInitialForgeConfig;
exports.fromBuildIdentifier = fromBuildIdentifier;
exports.default = void 0;

require("source-map-support/register");

var _fsExtra = _interopRequireDefault(require("fs-extra"));

var _path = _interopRequireDefault(require("path"));

var _lodash = _interopRequireDefault(require("lodash.template"));

var _readPackageJson = require("./read-package-json");

var _pluginInterface = _interopRequireDefault(require("./plugin-interface"));

var _hook = require("./hook");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function asyncGeneratorStep(gen, resolve, reject, _next, _throw, key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { Promise.resolve(value).then(_next, _throw); } }

function _asyncToGenerator(fn) { return function () { var self = this, args = arguments; return new Promise(function (resolve, reject) { var gen = fn.apply(self, args); function _next(value) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, "next", value); } function _throw(err) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, "throw", err); } _next(undefined); }); }; }

const underscoreCase = str => str.replace(/(.)([A-Z][a-z]+)/g, '$1_$2').replace(/([a-z0-9])([A-Z])/g, '$1_$2').toUpperCase();

const proxify = (buildIdentifier, object, envPrefix) => {
  let newObject = {};

  if (Array.isArray(object)) {
    newObject = [];
  }

  Object.keys(object).forEach(key => {
    const val = object[key];

    if (typeof val === 'object' && key !== 'pluginInterface' && !(val instanceof RegExp)) {
      newObject[key] = proxify(buildIdentifier, object[key], `${envPrefix}_${underscoreCase(key)}`);
    } else {
      newObject[key] = object[key];
    }
  });
  return new Proxy(newObject, {
    get(target, name, receiver) {
      // eslint-disable-next-line no-prototype-builtins
      if (!target.hasOwnProperty(name) && typeof name === 'string') {
        const envValue = process.env[`${envPrefix}_${underscoreCase(name)}`];
        if (envValue) return envValue;
      }

      const value = Reflect.get(target, name, receiver);

      if (value && typeof value === 'object' && value.__isMagicBuildIdentifierMap) {
        const identifier = typeof buildIdentifier === 'function' ? buildIdentifier() : buildIdentifier;
        return value.map[identifier];
      }

      return value;
    },

    getOwnPropertyDescriptor(target, name) {
      const envValue = process.env[`${envPrefix}_${underscoreCase(name)}`]; // eslint-disable-next-line no-prototype-builtins

      if (target.hasOwnProperty(name)) {
        return Reflect.getOwnPropertyDescriptor(target, name);
      }

      if (envValue) {
        return {
          writable: true,
          enumerable: true,
          configurable: true,
          value: envValue
        };
      }
    }

  });
};
/**
 * Sets sensible defaults for the `config.forge` object.
 */


function setInitialForgeConfig(packageJSON) {
  const _packageJSON$name = packageJSON.name,
        name = _packageJSON$name === void 0 ? '' : _packageJSON$name;
  /* eslint-disable no-param-reassign */

  packageJSON.config.forge.makers[0].config.name = name.replace(/-/g, '_');
  /* eslint-enable no-param-reassign */
}

function fromBuildIdentifier(map) {
  return {
    map,
    __isMagicBuildIdentifierMap: true
  };
}

var _default =
/*#__PURE__*/
function () {
  var _ref = _asyncToGenerator(function* (dir) {
    const packageJSON = yield (0, _readPackageJson.readRawPackageJson)(dir);
    let forgeConfig = packageJSON.config && packageJSON.config.forge ? packageJSON.config.forge : null;

    if (!forgeConfig) {
      if (yield _fsExtra.default.pathExists(_path.default.resolve(dir, 'forge.config.js'))) {
        forgeConfig = 'forge.config.js';
      } else {
        forgeConfig = {};
      }
    }

    if (typeof forgeConfig === 'string' && ((yield _fsExtra.default.pathExists(_path.default.resolve(dir, forgeConfig))) || (yield _fsExtra.default.pathExists(_path.default.resolve(dir, `${forgeConfig}.js`))))) {
      try {
        forgeConfig = require(_path.default.resolve(dir, forgeConfig));
      } catch (err) {
        console.error(`Failed to load: ${_path.default.resolve(dir, forgeConfig)}`);
        throw err;
      }
    } else if (typeof forgeConfig !== 'object') {
      throw new Error('Expected packageJSON.config.forge to be an object or point to a requirable JS file');
    }

    forgeConfig = Object.assign({
      packagerConfig: {},
      rebuildConfig: {},
      makers: [],
      publishers: [],
      plugins: []
    }, forgeConfig);
    const templateObj = Object.assign({}, packageJSON, {
      year: new Date().getFullYear()
    });

    const template = obj => {
      Object.keys(obj).forEach(objKey => {
        if (typeof obj[objKey] === 'object' && obj !== null) {
          template(obj[objKey]);
        } else if (typeof obj[objKey] === 'string') {
          obj[objKey] = (0, _lodash.default)(obj[objKey])(templateObj); // eslint-disable-line

          if (obj[objKey].startsWith('require:')) {
            obj[objKey] = require(_path.default.resolve(dir, obj[objKey].substr(8))); // eslint-disable-line
          }
        }
      });
    };

    template(forgeConfig);
    forgeConfig.pluginInterface = new _pluginInterface.default(dir, forgeConfig);
    forgeConfig = yield (0, _hook.runMutatingHook)(forgeConfig, 'resolveForgeConfig', forgeConfig);
    return proxify(forgeConfig.buildIdentifier || '', forgeConfig, 'ELECTRON_FORGE');
  });

  return function (_x) {
    return _ref.apply(this, arguments);
  };
}();

exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlsL2ZvcmdlLWNvbmZpZy50cyJdLCJuYW1lcyI6WyJ1bmRlcnNjb3JlQ2FzZSIsInN0ciIsInJlcGxhY2UiLCJ0b1VwcGVyQ2FzZSIsInByb3hpZnkiLCJidWlsZElkZW50aWZpZXIiLCJvYmplY3QiLCJlbnZQcmVmaXgiLCJuZXdPYmplY3QiLCJBcnJheSIsImlzQXJyYXkiLCJPYmplY3QiLCJrZXlzIiwiZm9yRWFjaCIsImtleSIsInZhbCIsIlJlZ0V4cCIsIlByb3h5IiwiZ2V0IiwidGFyZ2V0IiwibmFtZSIsInJlY2VpdmVyIiwiaGFzT3duUHJvcGVydHkiLCJlbnZWYWx1ZSIsInByb2Nlc3MiLCJlbnYiLCJ2YWx1ZSIsIlJlZmxlY3QiLCJfX2lzTWFnaWNCdWlsZElkZW50aWZpZXJNYXAiLCJpZGVudGlmaWVyIiwibWFwIiwiZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yIiwid3JpdGFibGUiLCJlbnVtZXJhYmxlIiwiY29uZmlndXJhYmxlIiwic2V0SW5pdGlhbEZvcmdlQ29uZmlnIiwicGFja2FnZUpTT04iLCJjb25maWciLCJmb3JnZSIsIm1ha2VycyIsImZyb21CdWlsZElkZW50aWZpZXIiLCJkaXIiLCJmb3JnZUNvbmZpZyIsImZzIiwicGF0aEV4aXN0cyIsInBhdGgiLCJyZXNvbHZlIiwicmVxdWlyZSIsImVyciIsImNvbnNvbGUiLCJlcnJvciIsIkVycm9yIiwiYXNzaWduIiwicGFja2FnZXJDb25maWciLCJyZWJ1aWxkQ29uZmlnIiwicHVibGlzaGVycyIsInBsdWdpbnMiLCJ0ZW1wbGF0ZU9iaiIsInllYXIiLCJEYXRlIiwiZ2V0RnVsbFllYXIiLCJ0ZW1wbGF0ZSIsIm9iaiIsIm9iaktleSIsInN0YXJ0c1dpdGgiLCJzdWJzdHIiLCJwbHVnaW5JbnRlcmZhY2UiLCJQbHVnaW5JbnRlcmZhY2UiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBQ0E7Ozs7Ozs7O0FB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LFlBQUksT0FBT0QsR0FBRyxDQUFDQyxNQUFELENBQVYsS0FBdUIsUUFBdkIsSUFBbUNELEdBQUcsS0FBSyxJQUEvQyxFQUFxRDtBQUNuREQsVUFBQUEsUUFBUSxDQUFDQyxHQUFHLENBQUNDLE1BQUQsQ0FBSixDQUFSO0FBQ0QsU0FGRCxNQUVPLElBQUksT0FBT0QsR0FBRyxDQUFDQyxNQUFELENBQVYsS0FBdUIsUUFBM0IsRUFBcUM7QUFDMUNELFVBQUFBLEdBQUcsQ0FBQ0MsTUFBRCxDQUFILEdBQWMscUJBQVVELEdBQUcsQ0FBQ0MsTUFBRCxDQUFiLEVBQXVCTixXQUF2QixDQUFkLENBRDBDLENBQ1M7O0FBQ25ELGNBQUlLLEdBQUcsQ0FBQ0MsTUFBRCxDQUFILENBQVlDLFVBQVosQ0FBdUIsVUFBdkIsQ0FBSixFQUF3QztBQUN0Q0YsWUFBQUEsR0FBRyxDQUFDQyxNQUFELENBQUgsR0FBY2hCLE9BQU8sQ0FBQ0YsY0FBS0MsT0FBTCxDQUFhTCxHQUFiLEVBQWtCcUIsR0FBRyxDQUFDQyxNQUFELENBQUgsQ0FBWUUsTUFBWixDQUFtQixDQUFuQixDQUFsQixDQUFELENBQXJCLENBRHNDLENBQzJCO0FBQ2xFO0FBQ0Y7QUFDRixPQVREO0FBVUQsS0FYRDs7QUFhQUosSUFBQUEsUUFBUSxDQUFDbkIsV0FBRCxDQUFSO0FBRUFBLElBQUFBLFdBQVcsQ0FBQ3dCLGVBQVosR0FBOEIsSUFBSUMsd0JBQUosQ0FBb0IxQixHQUFwQixFQUF5QkMsV0FBekIsQ0FBOUI7QUFFQUEsSUFBQUEsV0FBVyxTQUFTLDJCQUFnQkEsV0FBaEIsRUFBNkIsb0JBQTdCLEVBQW1EQSxXQUFuRCxDQUFwQjtBQUVBLFdBQU90QyxPQUFPLENBQWNzQyxXQUFXLENBQUNyQyxlQUFaLElBQStCLEVBQTdDLEVBQWlEcUMsV0FBakQsRUFBOEQsZ0JBQTlELENBQWQ7QUFDRCxHIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRm9yZ2VDb25maWcgfSBmcm9tICdAZWxlY3Ryb24tZm9yZ2Uvc2hhcmVkLXR5cGVzJztcbmltcG9ydCBmcyBmcm9tICdmcy1leHRyYSc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBfdGVtcGxhdGUgZnJvbSAnbG9kYXNoLnRlbXBsYXRlJztcblxuaW1wb3J0IHsgcmVhZFJhd1BhY2thZ2VKc29uIH0gZnJvbSAnLi9yZWFkLXBhY2thZ2UtanNvbic7XG5pbXBvcnQgUGx1Z2luSW50ZXJmYWNlIGZyb20gJy4vcGx1Z2luLWludGVyZmFjZSc7XG5pbXBvcnQgeyBydW5NdXRhdGluZ0hvb2sgfSBmcm9tICcuL2hvb2snO1xuXG5jb25zdCB1bmRlcnNjb3JlQ2FzZSA9IChzdHI6IHN0cmluZykgPT4gc3RyLnJlcGxhY2UoLyguKShbQS1aXVthLXpdKykvZywgJyQxXyQyJykucmVwbGFjZSgvKFthLXowLTldKShbQS1aXSkvZywgJyQxXyQyJykudG9VcHBlckNhc2UoKTtcblxuY29uc3QgcHJveGlmeSA9IDxUIGV4dGVuZHMgb2JqZWN0PihidWlsZElkZW50aWZpZXI6IHN0cmluZyB8ICgoKSA9PiBzdHJpbmcpLCBvYmplY3Q6IFQsIGVudlByZWZpeDogc3RyaW5nKTogVCA9PiB7XG4gIGxldCBuZXdPYmplY3Q6IFQgPSB7fSBhcyBhbnk7XG4gIGlmIChBcnJheS5pc0FycmF5KG9iamVjdCkpIHtcbiAgICBuZXdPYmplY3QgPSBbXSBhcyBhbnk7XG4gIH1cblxuICBPYmplY3Qua2V5cyhvYmplY3QpLmZvckVhY2goKGtleSkgPT4ge1xuICAgIGNvbnN0IHZhbCA9IChvYmplY3QgYXMgYW55KVtrZXldO1xuICAgIGlmICh0eXBlb2YgdmFsID09PSAnb2JqZWN0JyAmJiBrZXkgIT09ICdwbHVnaW5JbnRlcmZhY2UnICYmICEodmFsIGluc3RhbmNlb2YgUmVnRXhwKSkge1xuICAgICAgKG5ld09iamVjdCBhcyBhbnkpW2tleV0gPSBwcm94aWZ5KGJ1aWxkSWRlbnRpZmllciwgKG9iamVjdCBhcyBhbnkpW2tleV0sIGAke2VudlByZWZpeH1fJHt1bmRlcnNjb3JlQ2FzZShrZXkpfWApO1xuICAgIH0gZWxzZSB7XG4gICAgICAobmV3T2JqZWN0IGFzIGFueSlba2V5XSA9IChvYmplY3QgYXMgYW55KVtrZXldO1xuICAgIH1cbiAgfSk7XG5cbiAgcmV0dXJuIG5ldyBQcm94eTxUPihuZXdPYmplY3QsIHtcbiAgICBnZXQodGFyZ2V0LCBuYW1lLCByZWNlaXZlcikge1xuICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXByb3RvdHlwZS1idWlsdGluc1xuICAgICAgaWYgKCF0YXJnZXQuaGFzT3duUHJvcGVydHkobmFtZSkgJiYgdHlwZW9mIG5hbWUgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgIGNvbnN0IGVudlZhbHVlID0gcHJvY2Vzcy5lbnZbYCR7ZW52UHJlZml4fV8ke3VuZGVyc2NvcmVDYXNlKG5hbWUpfWBdO1xuICAgICAgICBpZiAoZW52VmFsdWUpIHJldHVybiBlbnZWYWx1ZTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IHZhbHVlID0gUmVmbGVjdC5nZXQodGFyZ2V0LCBuYW1lLCByZWNlaXZlcik7XG5cbiAgICAgIGlmICh2YWx1ZSAmJiB0eXBlb2YgdmFsdWUgPT09ICdvYmplY3QnICYmIHZhbHVlLl9faXNNYWdpY0J1aWxkSWRlbnRpZmllck1hcCkge1xuICAgICAgICBjb25zdCBpZGVudGlmaWVyID0gdHlwZW9mIGJ1aWxkSWRlbnRpZmllciA9PT0gJ2Z1bmN0aW9uJyA/IGJ1aWxkSWRlbnRpZmllcigpIDogYnVpbGRJZGVudGlmaWVyO1xuICAgICAgICByZXR1cm4gdmFsdWUubWFwW2lkZW50aWZpZXJdO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHZhbHVlO1xuICAgIH0sXG4gICAgZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHRhcmdldCwgbmFtZSkge1xuICAgICAgY29uc3QgZW52VmFsdWUgPSBwcm9jZXNzLmVudltgJHtlbnZQcmVmaXh9XyR7dW5kZXJzY29yZUNhc2UobmFtZSBhcyBzdHJpbmcpfWBdO1xuICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXByb3RvdHlwZS1idWlsdGluc1xuICAgICAgaWYgKHRhcmdldC5oYXNPd25Qcm9wZXJ0eShuYW1lKSkge1xuICAgICAgICByZXR1cm4gUmVmbGVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodGFyZ2V0LCBuYW1lKTtcbiAgICAgIH1cbiAgICAgIGlmIChlbnZWYWx1ZSkge1xuICAgICAgICByZXR1cm4geyB3cml0YWJsZTogdHJ1ZSwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB2YWx1ZTogZW52VmFsdWUgfTtcbiAgICAgIH1cbiAgICB9LFxuICB9KTtcbn07XG5cbi8qKlxuICogU2V0cyBzZW5zaWJsZSBkZWZhdWx0cyBmb3IgdGhlIGBjb25maWcuZm9yZ2VgIG9iamVjdC5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHNldEluaXRpYWxGb3JnZUNvbmZpZyhwYWNrYWdlSlNPTjogYW55KSB7XG4gIGNvbnN0IHsgbmFtZSA9ICcnIH0gPSBwYWNrYWdlSlNPTjtcblxuICAvKiBlc2xpbnQtZGlzYWJsZSBuby1wYXJhbS1yZWFzc2lnbiAqL1xuICBwYWNrYWdlSlNPTi5jb25maWcuZm9yZ2UubWFrZXJzWzBdLmNvbmZpZy5uYW1lID0gbmFtZS5yZXBsYWNlKC8tL2csICdfJyk7XG4gIC8qIGVzbGludC1lbmFibGUgbm8tcGFyYW0tcmVhc3NpZ24gKi9cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGZyb21CdWlsZElkZW50aWZpZXI8VD4obWFwOiB7IFtrZXk6IHN0cmluZ106IFQgfCB1bmRlZmluZWQgfSkge1xuICByZXR1cm4ge1xuICAgIG1hcCxcbiAgICBfX2lzTWFnaWNCdWlsZElkZW50aWZpZXJNYXA6IHRydWUsXG4gIH07XG59XG5cbmV4cG9ydCBkZWZhdWx0IGFzeW5jIChkaXI6IHN0cmluZykgPT4ge1xuICBjb25zdCBwYWNrYWdlSlNPTiA9IGF3YWl0IHJlYWRSYXdQYWNrYWdlSnNvbihkaXIpO1xuICBsZXQgZm9yZ2VDb25maWc6IEZvcmdlQ29uZmlnIHwgc3RyaW5nIHwgbnVsbCA9IChwYWNrYWdlSlNPTi5jb25maWcgJiYgcGFja2FnZUpTT04uY29uZmlnLmZvcmdlKSA/IHBhY2thZ2VKU09OLmNvbmZpZy5mb3JnZSA6IG51bGw7XG5cbiAgaWYgKCFmb3JnZUNvbmZpZykge1xuICAgIGlmIChhd2FpdCBmcy5wYXRoRXhpc3RzKHBhdGgucmVzb2x2ZShkaXIsICdmb3JnZS5jb25maWcuanMnKSkpIHtcbiAgICAgIGZvcmdlQ29uZmlnID0gJ2ZvcmdlLmNvbmZpZy5qcyc7XG4gICAgfSBlbHNlIHtcbiAgICAgIGZvcmdlQ29uZmlnID0ge30gYXMgYW55IGFzIEZvcmdlQ29uZmlnO1xuICAgIH1cbiAgfVxuXG4gIGlmICh0eXBlb2YgZm9yZ2VDb25maWcgPT09ICdzdHJpbmcnICYmIChhd2FpdCBmcy5wYXRoRXhpc3RzKHBhdGgucmVzb2x2ZShkaXIsIGZvcmdlQ29uZmlnKSkgfHwgYXdhaXQgZnMucGF0aEV4aXN0cyhwYXRoLnJlc29sdmUoZGlyLCBgJHtmb3JnZUNvbmZpZ30uanNgKSkpKSB7XG4gICAgdHJ5IHtcbiAgICAgIGZvcmdlQ29uZmlnID0gcmVxdWlyZShwYXRoLnJlc29sdmUoZGlyLCBmb3JnZUNvbmZpZykpIGFzIEZvcmdlQ29uZmlnO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgY29uc29sZS5lcnJvcihgRmFpbGVkIHRvIGxvYWQ6ICR7cGF0aC5yZXNvbHZlKGRpciwgZm9yZ2VDb25maWcpfWApO1xuICAgICAgdGhyb3cgZXJyO1xuICAgIH1cbiAgfSBlbHNlIGlmICh0eXBlb2YgZm9yZ2VDb25maWcgIT09ICdvYmplY3QnKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdFeHBlY3RlZCBwYWNrYWdlSlNPTi5jb25maWcuZm9yZ2UgdG8gYmUgYW4gb2JqZWN0IG9yIHBvaW50IHRvIGEgcmVxdWlyYWJsZSBKUyBmaWxlJyk7XG4gIH1cbiAgZm9yZ2VDb25maWcgPSBPYmplY3QuYXNzaWduKHtcbiAgICBwYWNrYWdlckNvbmZpZzoge30sXG4gICAgcmVidWlsZENvbmZpZzoge30sXG4gICAgbWFrZXJzOiBbXSxcbiAgICBwdWJsaXNoZXJzOiBbXSxcbiAgICBwbHVnaW5zOiBbXSxcbiAgfSwgZm9yZ2VDb25maWcpO1xuXG4gIGNvbnN0IHRlbXBsYXRlT2JqID0gT2JqZWN0LmFzc2lnbih7fSwgcGFja2FnZUpTT04sIHsgeWVhcjogKG5ldyBEYXRlKCkpLmdldEZ1bGxZZWFyKCkgfSk7XG4gIGNvbnN0IHRlbXBsYXRlID0gKG9iajogYW55KSA9PiB7XG4gICAgT2JqZWN0LmtleXMob2JqKS5mb3JFYWNoKChvYmpLZXkpID0+IHtcbiAgICAgIGlmICh0eXBlb2Ygb2JqW29iaktleV0gPT09ICdvYmplY3QnICYmIG9iaiAhPT0gbnVsbCkge1xuICAgICAgICB0ZW1wbGF0ZShvYmpbb2JqS2V5XSk7XG4gICAgICB9IGVsc2UgaWYgKHR5cGVvZiBvYmpbb2JqS2V5XSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgb2JqW29iaktleV0gPSBfdGVtcGxhdGUob2JqW29iaktleV0pKHRlbXBsYXRlT2JqKTsgLy8gZXNsaW50LWRpc2FibGUtbGluZVxuICAgICAgICBpZiAob2JqW29iaktleV0uc3RhcnRzV2l0aCgncmVxdWlyZTonKSkge1xuICAgICAgICAgIG9ialtvYmpLZXldID0gcmVxdWlyZShwYXRoLnJlc29sdmUoZGlyLCBvYmpbb2JqS2V5XS5zdWJzdHIoOCkpKTsgLy8gZXNsaW50LWRpc2FibGUtbGluZVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG4gIH07XG5cbiAgdGVtcGxhdGUoZm9yZ2VDb25maWcpO1xuXG4gIGZvcmdlQ29uZmlnLnBsdWdpbkludGVyZmFjZSA9IG5ldyBQbHVnaW5JbnRlcmZhY2UoZGlyLCBmb3JnZUNvbmZpZyk7XG5cbiAgZm9yZ2VDb25maWcgPSBhd2FpdCBydW5NdXRhdGluZ0hvb2soZm9yZ2VDb25maWcsICdyZXNvbHZlRm9yZ2VDb25maWcnLCBmb3JnZUNvbmZpZyk7XG5cbiAgcmV0dXJuIHByb3hpZnk8Rm9yZ2VDb25maWc+KGZvcmdlQ29uZmlnLmJ1aWxkSWRlbnRpZmllciB8fCAnJywgZm9yZ2VDb25maWcsICdFTEVDVFJPTl9GT1JHRScpO1xufTtcbiJdfQ==