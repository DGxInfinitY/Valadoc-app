"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = upgradeForgeConfig;
exports.updateUpgradedForgeDevDeps = updateUpgradedForgeDevDeps;

require("source-map-support/register");

var _path = _interopRequireDefault(require("path"));

var _initNpm = require("../api/init-scripts/init-npm");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }

function _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }

function _slicedToArray(arr, i) { return _arrayWithHoles(arr) || _iterableToArrayLimit(arr, i) || _nonIterableRest(); }

function _nonIterableRest() { throw new TypeError("Invalid attempt to destructure non-iterable instance"); }

function _iterableToArrayLimit(arr, i) { var _arr = []; var _n = true; var _d = false; var _e = undefined; try { for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i["return"] != null) _i["return"](); } finally { if (_d) throw _e; } } return _arr; }

function _arrayWithHoles(arr) { if (Array.isArray(arr)) return arr; }

function mapMakeTargets(forge5Config) {
  const makeTargets = new Map();

  if (forge5Config.makeTargets) {
    // TODO: Use object.entries when dropping Node 6
    for (const platform in forge5Config.makeTargets) {
      var _iteratorNormalCompletion = true;
      var _didIteratorError = false;
      var _iteratorError = undefined;

      try {
        for (var _iterator = forge5Config.makeTargets[platform][Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
          const target = _step.value;
          let platforms = makeTargets.get(target);

          if (platforms === undefined) {
            platforms = [];
            makeTargets.set(target, platforms);
          }

          platforms.push(platform);
        }
      } catch (err) {
        _didIteratorError = true;
        _iteratorError = err;
      } finally {
        try {
          if (!_iteratorNormalCompletion && _iterator.return != null) {
            _iterator.return();
          }
        } finally {
          if (_didIteratorError) {
            throw _iteratorError;
          }
        }
      }
    }
  }

  return makeTargets;
}

const forge5MakerMappings = new Map([['electronInstallerDebian', 'deb'], ['electronInstallerDMG', 'dmg'], ['electronInstallerFlatpak', 'flatpak'], ['electronInstallerRedhat', 'rpm'], ['electronInstallerSnap', 'snap'], ['electronWinstallerConfig', 'squirrel'], ['electronWixMSIConfig', 'wix'], ['windowsStoreConfig', 'appx']]);
/**
 * Converts Forge v5 maker config to v6.
 */

function generateForgeMakerConfig(forge5Config) {
  const makeTargets = mapMakeTargets(forge5Config);
  const makers = [];
  var _iteratorNormalCompletion2 = true;
  var _didIteratorError2 = false;
  var _iteratorError2 = undefined;

  try {
    for (var _iterator2 = forge5MakerMappings[Symbol.iterator](), _step2; !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
      const _step2$value = _slicedToArray(_step2.value, 2),
            forge5Key = _step2$value[0],
            makerType = _step2$value[1];

      const config = forge5Config[forge5Key];

      if (config) {
        makers.push({
          name: `@electron-forge/maker-${makerType}`,
          config: forge5Config[forge5Key],
          platforms: makeTargets.get(makerType) || null
        });
      }
    }
  } catch (err) {
    _didIteratorError2 = true;
    _iteratorError2 = err;
  } finally {
    try {
      if (!_iteratorNormalCompletion2 && _iterator2.return != null) {
        _iterator2.return();
      }
    } finally {
      if (_didIteratorError2) {
        throw _iteratorError2;
      }
    }
  }

  const zipPlatforms = makeTargets.get('zip');

  if (zipPlatforms) {
    makers.push({
      name: '@electron-forge/maker-zip',
      platforms: zipPlatforms
    });
  }

  return makers;
}

const forge5PublisherMappings = new Map([['github_repository', 'github'], ['s3', 's3'], ['electron-release-server', 'electron-release-server'], ['snapStore', 'snapcraft']]);
/**
 * Converts Forge v5 publisher config to v6.
 */

function generateForgePublisherConfig(forge5Config) {
  const publishers = [];
  var _iteratorNormalCompletion3 = true;
  var _didIteratorError3 = false;
  var _iteratorError3 = undefined;

  try {
    for (var _iterator3 = forge5PublisherMappings[Symbol.iterator](), _step3; !(_iteratorNormalCompletion3 = (_step3 = _iterator3.next()).done); _iteratorNormalCompletion3 = true) {
      const _step3$value = _slicedToArray(_step3.value, 2),
            forge5Key = _step3$value[0],
            publisherType = _step3$value[1];

      let config = forge5Config[forge5Key];

      if (config) {
        if (publisherType === 'github') {
          config = transformGitHubPublisherConfig(config);
        }

        publishers.push({
          config,
          name: `@electron-forge/publisher-${publisherType}`,
          platforms: null
        });
      }
    }
  } catch (err) {
    _didIteratorError3 = true;
    _iteratorError3 = err;
  } finally {
    try {
      if (!_iteratorNormalCompletion3 && _iterator3.return != null) {
        _iterator3.return();
      }
    } finally {
      if (_didIteratorError3) {
        throw _iteratorError3;
      }
    }
  }

  return publishers;
}
/**
 * Transforms v5 GitHub publisher config to v6 syntax.
 */


function transformGitHubPublisherConfig(config) {
  const name = config.name,
        owner = config.owner,
        options = config.options,
        gitHubConfig = _objectWithoutProperties(config, ["name", "owner", "options"]);

  gitHubConfig.repository = {
    name,
    owner
  };

  if (options) {
    gitHubConfig.octokitOptions = options;
  }

  return gitHubConfig;
}
/**
 * Upgrades Forge v5 config to v6.
 */


function upgradeForgeConfig(forge5Config) {
  const forgeConfig = {};

  if (forge5Config.electronPackagerConfig) {
    delete forge5Config.electronPackagerConfig.packageManager;
    forgeConfig.packagerConfig = forge5Config.electronPackagerConfig;
  }

  if (forge5Config.electronRebuildConfig) {
    forgeConfig.electronRebuildConfig = forge5Config.electronRebuildConfig;
  }

  forgeConfig.makers = generateForgeMakerConfig(forge5Config);
  forgeConfig.publishers = generateForgePublisherConfig(forge5Config);
  return forgeConfig;
}

function updateUpgradedForgeDevDeps(packageJSON, devDeps) {
  const forgeConfig = packageJSON.config.forge;
  devDeps = devDeps.filter(dep => !dep.startsWith('@electron-forge/maker-'));
  devDeps = devDeps.concat(forgeConfig.makers.map(maker => (0, _initNpm.siblingDep)(_path.default.basename(maker.name))));
  devDeps = devDeps.concat(forgeConfig.publishers.map(publisher => (0, _initNpm.siblingDep)(_path.default.basename(publisher.name))));

  if (Object.keys(packageJSON.devDependencies).find(dep => dep === 'electron-prebuilt-compile')) {
    devDeps = devDeps.concat((0, _initNpm.siblingDep)('plugin-compile'));
  }

  return devDeps;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlsL3VwZ3JhZGUtZm9yZ2UtY29uZmlnLnRzIl0sIm5hbWVzIjpbIm1hcE1ha2VUYXJnZXRzIiwiZm9yZ2U1Q29uZmlnIiwibWFrZVRhcmdldHMiLCJNYXAiLCJwbGF0Zm9ybSIsInRhcmdldCIsInBsYXRmb3JtcyIsImdldCIsInVuZGVmaW5lZCIsInNldCIsInB1c2giLCJmb3JnZTVNYWtlck1hcHBpbmdzIiwiZ2VuZXJhdGVGb3JnZU1ha2VyQ29uZmlnIiwibWFrZXJzIiwiZm9yZ2U1S2V5IiwibWFrZXJUeXBlIiwiY29uZmlnIiwibmFtZSIsInppcFBsYXRmb3JtcyIsImZvcmdlNVB1Ymxpc2hlck1hcHBpbmdzIiwiZ2VuZXJhdGVGb3JnZVB1Ymxpc2hlckNvbmZpZyIsInB1Ymxpc2hlcnMiLCJwdWJsaXNoZXJUeXBlIiwidHJhbnNmb3JtR2l0SHViUHVibGlzaGVyQ29uZmlnIiwib3duZXIiLCJvcHRpb25zIiwiZ2l0SHViQ29uZmlnIiwicmVwb3NpdG9yeSIsIm9jdG9raXRPcHRpb25zIiwidXBncmFkZUZvcmdlQ29uZmlnIiwiZm9yZ2VDb25maWciLCJlbGVjdHJvblBhY2thZ2VyQ29uZmlnIiwicGFja2FnZU1hbmFnZXIiLCJwYWNrYWdlckNvbmZpZyIsImVsZWN0cm9uUmVidWlsZENvbmZpZyIsInVwZGF0ZVVwZ3JhZGVkRm9yZ2VEZXZEZXBzIiwicGFja2FnZUpTT04iLCJkZXZEZXBzIiwiZm9yZ2UiLCJmaWx0ZXIiLCJkZXAiLCJzdGFydHNXaXRoIiwiY29uY2F0IiwibWFwIiwibWFrZXIiLCJwYXRoIiwiYmFzZW5hbWUiLCJwdWJsaXNoZXIiLCJPYmplY3QiLCJrZXlzIiwiZGV2RGVwZW5kZW5jaWVzIiwiZmluZCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7OztBQU1BOztBQUNBOzs7Ozs7Ozs7Ozs7Ozs7O0FBRUEsU0FBU0EsY0FBVCxDQUF3QkMsWUFBeEIsRUFBeUU7QUFDdkUsUUFBTUMsV0FBVyxHQUFHLElBQUlDLEdB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Q0FBdUJzQixHQUF2QixDQUE0QkksU0FBRCxJQUEwQyx5QkFBV0YsY0FBS0MsUUFBTCxDQUFjQyxTQUFTLENBQUM5QixJQUF4QixDQUFYLENBQXJFLENBQWYsQ0FBVjs7QUFFQSxNQUFJK0IsTUFBTSxDQUFDQyxJQUFQLENBQVliLFdBQVcsQ0FBQ2MsZUFBeEIsRUFBeUNDLElBQXpDLENBQStDWCxHQUFELElBQWlCQSxHQUFHLEtBQUssMkJBQXZFLENBQUosRUFBeUc7QUFDdkdILElBQUFBLE9BQU8sR0FBR0EsT0FBTyxDQUFDSyxNQUFSLENBQWUseUJBQVcsZ0JBQVgsQ0FBZixDQUFWO0FBQ0Q7O0FBRUQsU0FBT0wsT0FBUDtBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgRm9yZ2VDb25maWcsXG4gIEZvcmdlUGxhdGZvcm0sXG4gIElGb3JnZVJlc29sdmFibGVNYWtlcixcbiAgSUZvcmdlUmVzb2x2YWJsZVB1Ymxpc2hlcixcbn0gZnJvbSAnQGVsZWN0cm9uLWZvcmdlL3NoYXJlZC10eXBlcyc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IHNpYmxpbmdEZXAgfSBmcm9tICcuLi9hcGkvaW5pdC1zY3JpcHRzL2luaXQtbnBtJztcblxuZnVuY3Rpb24gbWFwTWFrZVRhcmdldHMoZm9yZ2U1Q29uZmlnOiBhbnkpOiBNYXA8c3RyaW5nLCBGb3JnZVBsYXRmb3JtW10+IHtcbiAgY29uc3QgbWFrZVRhcmdldHMgPSBuZXcgTWFwPHN0cmluZywgRm9yZ2VQbGF0Zm9ybVtdPigpO1xuICBpZiAoZm9yZ2U1Q29uZmlnLm1ha2VUYXJnZXRzKSB7XG4gICAgLy8gVE9ETzogVXNlIG9iamVjdC5lbnRyaWVzIHdoZW4gZHJvcHBpbmcgTm9kZSA2XG4gICAgZm9yIChjb25zdCBwbGF0Zm9ybSBpbiBmb3JnZTVDb25maWcubWFrZVRhcmdldHMpIHtcbiAgICAgIGZvciAoY29uc3QgdGFyZ2V0IG9mIGZvcmdlNUNvbmZpZy5tYWtlVGFyZ2V0c1twbGF0Zm9ybV0pIHtcbiAgICAgICAgbGV0IHBsYXRmb3JtcyA9IG1ha2VUYXJnZXRzLmdldCh0YXJnZXQpO1xuICAgICAgICBpZiAocGxhdGZvcm1zID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICBwbGF0Zm9ybXMgPSBbXTtcbiAgICAgICAgICBtYWtlVGFyZ2V0cy5zZXQodGFyZ2V0LCBwbGF0Zm9ybXMpO1xuICAgICAgICB9XG4gICAgICAgIHBsYXRmb3Jtcy5wdXNoKHBsYXRmb3JtIGFzIEZvcmdlUGxhdGZvcm0pO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHJldHVybiBtYWtlVGFyZ2V0cztcbn1cblxuY29uc3QgZm9yZ2U1TWFrZXJNYXBwaW5ncyA9IG5ldyBNYXA8c3RyaW5nLCBzdHJpbmc+KFtcbiAgWydlbGVjdHJvbkluc3RhbGxlckRlYmlhbicsICdkZWInXSxcbiAgWydlbGVjdHJvbkluc3RhbGxlckRNRycsICdkbWcnXSxcbiAgWydlbGVjdHJvbkluc3RhbGxlckZsYXRwYWsnLCAnZmxhdHBhayddLFxuICBbJ2VsZWN0cm9uSW5zdGFsbGVyUmVkaGF0JywgJ3JwbSddLFxuICBbJ2VsZWN0cm9uSW5zdGFsbGVyU25hcCcsICdzbmFwJ10sXG4gIFsnZWxlY3Ryb25XaW5zdGFsbGVyQ29uZmlnJywgJ3NxdWlycmVsJ10sXG4gIFsnZWxlY3Ryb25XaXhNU0lDb25maWcnLCAnd2l4J10sXG4gIFsnd2luZG93c1N0b3JlQ29uZmlnJywgJ2FwcHgnXSxcbl0pO1xuXG4vKipcbiAqIENvbnZlcnRzIEZvcmdlIHY1IG1ha2VyIGNvbmZpZyB0byB2Ni5cbiAqL1xuZnVuY3Rpb24gZ2VuZXJhdGVGb3JnZU1ha2VyQ29uZmlnKGZvcmdlNUNvbmZpZzogYW55KTogSUZvcmdlUmVzb2x2YWJsZU1ha2VyW10ge1xuICBjb25zdCBtYWtlVGFyZ2V0cyA9IG1hcE1ha2VUYXJnZXRzKGZvcmdlNUNvbmZpZyk7XG4gIGNvbnN0IG1ha2VyczogSUZvcmdlUmVzb2x2YWJsZU1ha2VyW10gPSBbXTtcblxuICBmb3IgKGNvbnN0IFtmb3JnZTVLZXksIG1ha2VyVHlwZV0gb2YgZm9yZ2U1TWFrZXJNYXBwaW5ncykge1xuICAgIGNvbnN0IGNvbmZpZyA9IGZvcmdlNUNvbmZpZ1tmb3JnZTVLZXldO1xuICAgIGlmIChjb25maWcpIHtcbiAgICAgIG1ha2Vycy5wdXNoKHtcbiAgICAgICAgbmFtZTogYEBlbGVjdHJvbi1mb3JnZS9tYWtlci0ke21ha2VyVHlwZX1gLFxuICAgICAgICBjb25maWc6IGZvcmdlNUNvbmZpZ1tmb3JnZTVLZXldLFxuICAgICAgICBwbGF0Zm9ybXM6IG1ha2VUYXJnZXRzLmdldChtYWtlclR5cGUpIHx8IG51bGwsXG4gICAgICB9IGFzIElGb3JnZVJlc29sdmFibGVNYWtlcik7XG4gICAgfVxuICB9XG5cbiAgY29uc3QgemlwUGxhdGZvcm1zID0gbWFrZVRhcmdldHMuZ2V0KCd6aXAnKTtcbiAgaWYgKHppcFBsYXRmb3Jtcykge1xuICAgIG1ha2Vycy5wdXNoKHtcbiAgICAgIG5hbWU6ICdAZWxlY3Ryb24tZm9yZ2UvbWFrZXItemlwJyxcbiAgICAgIHBsYXRmb3JtczogemlwUGxhdGZvcm1zLFxuICAgIH0gYXMgSUZvcmdlUmVzb2x2YWJsZU1ha2VyKTtcbiAgfVxuXG4gIHJldHVybiBtYWtlcnM7XG59XG5cbmNvbnN0IGZvcmdlNVB1Ymxpc2hlck1hcHBpbmdzID0gbmV3IE1hcDxzdHJpbmcsIHN0cmluZz4oW1xuICBbJ2dpdGh1Yl9yZXBvc2l0b3J5JywgJ2dpdGh1YiddLFxuICBbJ3MzJywgJ3MzJ10sXG4gIFsnZWxlY3Ryb24tcmVsZWFzZS1zZXJ2ZXInLCAnZWxlY3Ryb24tcmVsZWFzZS1zZXJ2ZXInXSxcbiAgWydzbmFwU3RvcmUnLCAnc25hcGNyYWZ0J10sXG5dKTtcblxuLyoqXG4gKiBDb252ZXJ0cyBGb3JnZSB2NSBwdWJsaXNoZXIgY29uZmlnIHRvIHY2LlxuICovXG5mdW5jdGlvbiBnZW5lcmF0ZUZvcmdlUHVibGlzaGVyQ29uZmlnKGZvcmdlNUNvbmZpZzogYW55KTogSUZvcmdlUmVzb2x2YWJsZVB1Ymxpc2hlcltdIHtcbiAgY29uc3QgcHVibGlzaGVyczogSUZvcmdlUmVzb2x2YWJsZVB1Ymxpc2hlcltdID0gW107XG5cbiAgZm9yIChjb25zdCBbZm9yZ2U1S2V5LCBwdWJsaXNoZXJUeXBlXSBvZiBmb3JnZTVQdWJsaXNoZXJNYXBwaW5ncykge1xuICAgIGxldCBjb25maWcgPSBmb3JnZTVDb25maWdbZm9yZ2U1S2V5XTtcbiAgICBpZiAoY29uZmlnKSB7XG4gICAgICBpZiAocHVibGlzaGVyVHlwZSA9PT0gJ2dpdGh1YicpIHtcbiAgICAgICAgY29uZmlnID0gdHJhbnNmb3JtR2l0SHViUHVibGlzaGVyQ29uZmlnKGNvbmZpZyk7XG4gICAgICB9XG4gICAgICBwdWJsaXNoZXJzLnB1c2goe1xuICAgICAgICBjb25maWcsXG4gICAgICAgIG5hbWU6IGBAZWxlY3Ryb24tZm9yZ2UvcHVibGlzaGVyLSR7cHVibGlzaGVyVHlwZX1gLFxuICAgICAgICBwbGF0Zm9ybXM6IG51bGwsXG4gICAgICB9IGFzIElGb3JnZVJlc29sdmFibGVNYWtlcik7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIHB1Ymxpc2hlcnM7XG59XG5cbi8qKlxuICogVHJhbnNmb3JtcyB2NSBHaXRIdWIgcHVibGlzaGVyIGNvbmZpZyB0byB2NiBzeW50YXguXG4gKi9cbmZ1bmN0aW9uIHRyYW5zZm9ybUdpdEh1YlB1Ymxpc2hlckNvbmZpZyhjb25maWc6IGFueSkge1xuICBjb25zdCB7IG5hbWUsIG93bmVyLCBvcHRpb25zLCAuLi5naXRIdWJDb25maWcgfSA9IGNvbmZpZztcbiAgZ2l0SHViQ29uZmlnLnJlcG9zaXRvcnkgPSB7IG5hbWUsIG93bmVyIH07XG4gIGlmIChvcHRpb25zKSB7XG4gICAgZ2l0SHViQ29uZmlnLm9jdG9raXRPcHRpb25zID0gb3B0aW9ucztcbiAgfVxuXG4gIHJldHVybiBnaXRIdWJDb25maWc7XG59XG5cbi8qKlxuICogVXBncmFkZXMgRm9yZ2UgdjUgY29uZmlnIHRvIHY2LlxuICovXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiB1cGdyYWRlRm9yZ2VDb25maWcoZm9yZ2U1Q29uZmlnOiBhbnkpOiBGb3JnZUNvbmZpZyB7XG4gIGNvbnN0IGZvcmdlQ29uZmlnOiBGb3JnZUNvbmZpZyA9ICh7fSBhcyBGb3JnZUNvbmZpZyk7XG5cbiAgaWYgKGZvcmdlNUNvbmZpZy5lbGVjdHJvblBhY2thZ2VyQ29uZmlnKSB7XG4gICAgZGVsZXRlIGZvcmdlNUNvbmZpZy5lbGVjdHJvblBhY2thZ2VyQ29uZmlnLnBhY2thZ2VNYW5hZ2VyO1xuICAgIGZvcmdlQ29uZmlnLnBhY2thZ2VyQ29uZmlnID0gZm9yZ2U1Q29uZmlnLmVsZWN0cm9uUGFja2FnZXJDb25maWc7XG4gIH1cbiAgaWYgKGZvcmdlNUNvbmZpZy5lbGVjdHJvblJlYnVpbGRDb25maWcpIHtcbiAgICBmb3JnZUNvbmZpZy5lbGVjdHJvblJlYnVpbGRDb25maWcgPSBmb3JnZTVDb25maWcuZWxlY3Ryb25SZWJ1aWxkQ29uZmlnO1xuICB9XG4gIGZvcmdlQ29uZmlnLm1ha2VycyA9IGdlbmVyYXRlRm9yZ2VNYWtlckNvbmZpZyhmb3JnZTVDb25maWcpO1xuICBmb3JnZUNvbmZpZy5wdWJsaXNoZXJzID0gZ2VuZXJhdGVGb3JnZVB1Ymxpc2hlckNvbmZpZyhmb3JnZTVDb25maWcpO1xuXG4gIHJldHVybiBmb3JnZUNvbmZpZztcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHVwZGF0ZVVwZ3JhZGVkRm9yZ2VEZXZEZXBzKHBhY2thZ2VKU09OOiBhbnksIGRldkRlcHM6IHN0cmluZ1tdKTogc3RyaW5nW10ge1xuICBjb25zdCBmb3JnZUNvbmZpZyA9IHBhY2thZ2VKU09OLmNvbmZpZy5mb3JnZTtcbiAgZGV2RGVwcyA9IGRldkRlcHMuZmlsdGVyKGRlcCA9PiAhZGVwLnN0YXJ0c1dpdGgoJ0BlbGVjdHJvbi1mb3JnZS9tYWtlci0nKSk7XG4gIGRldkRlcHMgPSBkZXZEZXBzLmNvbmNhdChmb3JnZUNvbmZpZy5tYWtlcnMubWFwKChtYWtlcjogSUZvcmdlUmVzb2x2YWJsZU1ha2VyKSA9PiBzaWJsaW5nRGVwKHBhdGguYmFzZW5hbWUobWFrZXIubmFtZSkpKSk7XG4gIGRldkRlcHMgPSBkZXZEZXBzLmNvbmNhdChmb3JnZUNvbmZpZy5wdWJsaXNoZXJzLm1hcCgocHVibGlzaGVyOiBJRm9yZ2VSZXNvbHZhYmxlUHVibGlzaGVyKSA9PiBzaWJsaW5nRGVwKHBhdGguYmFzZW5hbWUocHVibGlzaGVyLm5hbWUpKSkpO1xuXG4gIGlmIChPYmplY3Qua2V5cyhwYWNrYWdlSlNPTi5kZXZEZXBlbmRlbmNpZXMpLmZpbmQoKGRlcDogc3RyaW5nKSA9PiBkZXAgPT09ICdlbGVjdHJvbi1wcmVidWlsdC1jb21waWxlJykpIHtcbiAgICBkZXZEZXBzID0gZGV2RGVwcy5jb25jYXQoc2libGluZ0RlcCgncGx1Z2luLWNvbXBpbGUnKSk7XG4gIH1cblxuICByZXR1cm4gZGV2RGVwcztcbn1cbiJdfQ==