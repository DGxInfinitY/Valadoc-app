"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
Object.defineProperty(exports, "StartOptions", {
  enumerable: true,
  get: function get() {
    return _sharedTypes.StartOptions;
  }
});
exports.default = void 0;

require("source-map-support/register");

require("colors");

var _asyncOra = require("@electron-forge/async-ora");

var _sharedTypes = require("@electron-forge/shared-types");

var _child_process = require("child_process");

var _path = _interopRequireDefault(require("path"));

var _readPackageJson = require("../util/read-package-json");

var _rebuild = _interopRequireDefault(require("../util/rebuild"));

var _resolveDir = _interopRequireDefault(require("../util/resolve-dir"));

var _forgeConfig = _interopRequireDefault(require("../util/forge-config"));

var _hook = require("../util/hook");

var _electronVersion = require("../util/electron-version");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function asyncGeneratorStep(gen, resolve, reject, _next, _throw, key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { Promise.resolve(value).then(_next, _throw); } }

function _asyncToGenerator(fn) { return function () { var self = this, args = arguments; return new Promise(function (resolve, reject) { var gen = fn.apply(self, args); function _next(value) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, "next", value); } function _throw(err) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, "throw", err); } _next(undefined); }); }; }

var _default =
/*#__PURE__*/
function () {
  var _ref = _asyncToGenerator(function* ({
    dir = process.cwd(),
    appPath = '.',
    interactive = false,
    enableLogging = false,
    args = [],
    runAsNode = false,
    inspect = false
  }) {
    _asyncOra.asyncOra.interactive = interactive;
    yield (0, _asyncOra.asyncOra)('Locating Application',
    /*#__PURE__*/
    _asyncToGenerator(function* () {
      const resolvedDir = yield (0, _resolveDir.default)(dir);

      if (!resolvedDir) {
        throw 'Failed to locate startable Electron application';
      }

      dir = resolvedDir;
    }));
    const forgeConfig = yield (0, _forgeConfig.default)(dir);
    const packageJSON = yield (0, _readPackageJson.readMutatedPackageJson)(dir, forgeConfig);

    if (!packageJSON.version) {
      throw `Please set your application's 'version' in '${dir}/package.json'.`;
    }

    yield (0, _rebuild.default)(dir, (yield (0, _electronVersion.getElectronVersion)(dir, packageJSON)), process.platform, process.arch, forgeConfig.electronRebuildConfig);
    yield (0, _hook.runHook)(forgeConfig, 'generateAssets');
    let lastSpawned = null;

    const forgeSpawnWrapper =
    /*#__PURE__*/
    function () {
      var _ref3 = _asyncToGenerator(function* () {
        lastSpawned = yield forgeSpawn(); // When the child app is closed we should stop listening for stdin

        if (lastSpawned) {
          if (interactive && process.stdin.isPaused()) {
            process.stdin.resume();
          }

          lastSpawned.on('exit', () => {
            if (lastSpawned.restarted) return;
            if (!process.stdin.isPaused()) process.stdin.pause();
          });
        } else {
          if (interactive && !process.stdin.isPaused()) {
            process.stdin.pause();
          }
        }

        return lastSpawned;
      });

      return function forgeSpawnWrapper() {
        return _ref3.apply(this, arguments);
      };
    }();

    const forgeSpawn =
    /*#__PURE__*/
    function () {
      var _ref4 = _asyncToGenerator(function* () {
        let electronExecPath = null; // If a plugin has taken over the start command let's stop here

        const spawnedPluginChild = yield forgeConfig.pluginInterface.overrideStartLogic({
          dir,
          appPath,
          interactive,
          enableLogging,
          args,
          runAsNode,
          inspect
        });
        let prefixArgs = [];

        if (typeof spawnedPluginChild === 'string') {
          electronExecPath = spawnedPluginChild;
        } else if (Array.isArray(spawnedPluginChild)) {
          electronExecPath = spawnedPluginChild[0];
          prefixArgs = spawnedPluginChild.slice(1);
        } else if (spawnedPluginChild) {
          yield (0, _hook.runHook)(forgeConfig, 'postStart', spawnedPluginChild);
          return spawnedPluginChild;
        }

        if (!electronExecPath) {
          electronExecPath = require(_path.default.resolve(dir, 'node_modules/electron'));
        }

        const spawnOpts = {
          cwd: dir,
          stdio: 'inherit',
          env: Object.assign({}, process.env, enableLogging ? {
            ELECTRON_ENABLE_LOGGING: 'true',
            ELECTRON_ENABLE_STACK_DUMPING: 'true'
          } : {})
        };

        if (runAsNode) {
          spawnOpts.env.ELECTRON_RUN_AS_NODE = 'true';
        } else {
          delete spawnOpts.env.ELECTRON_RUN_AS_NODE;
        }

        if (inspect) {
          args = ['--inspect'].concat(args);
        }

        let spawned;
        yield (0, _asyncOra.asyncOra)('Launching Application',
        /*#__PURE__*/
        _asyncToGenerator(function* () {
          spawned = (0, _child_process.spawn)(electronExecPath, prefixArgs.concat([appPath]).concat(args), spawnOpts);
        }));
        yield (0, _hook.runHook)(forgeConfig, 'postStart', spawned);
        return spawned;
      });

      return function forgeSpawn() {
        return _ref4.apply(this, arguments);
      };
    }();

    if (interactive) {
      process.stdin.on('data',
      /*#__PURE__*/
      function () {
        var _ref6 = _asyncToGenerator(function* (data) {
          if (data.toString().trim() === 'rs' && lastSpawned) {
            console.info('\nRestarting App\n'.cyan);
            lastSpawned.restarted = true;
            lastSpawned.kill('SIGTERM');
            lastSpawned.emit('restarted', (yield forgeSpawnWrapper()));
          }
        });

        return function (_x2) {
          return _ref6.apply(this, arguments);
        };
      }());
    }

    return forgeSpawnWrapper();
  });

  return function (_x) {
    return _ref.apply(this, arguments);
  };
}();

exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hcGkvc3RhcnQudHMiXSwibmFtZXMiOlsiZGlyIiwicHJvY2VzcyIsImN3ZCIsImFwcFBhdGgiLCJpbnRlcmFjdGl2ZSIsImVuYWJsZUxvZ2dpbmciLCJhcmdzIiwicnVuQXNOb2RlIiwiaW5zcGVjdCIsImFzeW5jT3JhIiwicmVzb2x2ZWREaXIiLCJmb3JnZUNvbmZpZyIsInBhY2thZ2VKU09OIiwidmVyc2lvbiIsInBsYXRmb3JtIiwiYXJjaCIsImVsZWN0cm9uUmVidWlsZENvbmZpZyIsImxhc3RTcGF3bmVkIiwiZm9yZ2VTcGF3bldyYXBwZXIiLCJmb3JnZVNwYXduIiwic3RkaW4iLCJpc1BhdXNlZCIsInJlc3VtZSIsIm9uIiwicmVzdGFydGVkIiwicGF1c2UiLCJlbGVjdHJvbkV4ZWNQYXRoIiwic3Bhd25lZFBsdWdpbkNoaWxkIiwicGx1Z2luSW50ZXJmYWNlIiwib3ZlcnJpZGVTdGFydExvZ2ljIiwicHJlZml4QXJncyIsIkFycmF5IiwiaXNBcnJheSIsInNsaWNlIiwicmVxdWlyZSIsInBhdGgiLCJyZXNvbHZlIiwic3Bhd25PcHRzIiwic3RkaW8iLCJlbnYiLCJPYmplY3QiLCJhc3NpZ24iLCJFTEVDVFJPTl9FTkFCTEVfTE9HR0lORyIsIkVMRUNUUk9OX0VOQUJMRV9TVEFDS19EVU1QSU5HIiwiRUxFQ1RST05fUlVOX0FTX05PREUiLCJjb25jYXQiLCJzcGF3bmVkIiwiZGF0YSIsInRvU3RyaW5nIiwidHJpbSIsImNvbnNvbGUiLCJpbmZvIiwiY3lhbiIsImtpbGwiLCJlbWl0Il0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7Ozs7Ozs7Ozs7K0JBSWUsV0FBTztBQUNwQkEsSUFBQUEsR0FBRyxHQUFHQyxPQUFPLENBQUNDLEdBQVIsRUFEYztBQUVwQkMsSUFBQUEsT0FBTyxHQUFHLEdBRlU7QUFHcEJD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LFVBQUFBLE9BQU8sR0FBRywwQkFBTXBCLGdCQUFOLEVBQXlCSSxVQUFVLENBQUNlLE1BQVgsQ0FBa0IsQ0FBQzFDLE9BQUQsQ0FBbEIsRUFBNkIwQyxNQUE3QixDQUFvQ3ZDLElBQXBDLENBQXpCLEVBQWdGK0IsU0FBaEYsQ0FBVjtBQUNELFNBRkssRUFBTjtBQUlBLGNBQU0sbUJBQVExQixXQUFSLEVBQXFCLFdBQXJCLEVBQWtDbUMsT0FBbEMsQ0FBTjtBQUNBLGVBQU9BLE9BQVA7QUFDRCxPQXZEZTs7QUFBQSxzQkFBVjNCLFVBQVU7QUFBQTtBQUFBO0FBQUEsT0FBaEI7O0FBeURBLFFBQUlmLFdBQUosRUFBaUI7QUFDZkgsTUFBQUEsT0FBTyxDQUFDbUIsS0FBUixDQUFjRyxFQUFkLENBQWlCLE1BQWpCO0FBQUE7QUFBQTtBQUFBLHNDQUF5QixXQUFPd0IsSUFBUCxFQUFnQjtBQUN2QyxjQUFJQSxJQUFJLENBQUNDLFFBQUwsR0FBZ0JDLElBQWhCLE9BQTJCLElBQTNCLElBQW1DaEMsV0FBdkMsRUFBb0Q7QUFDbERpQyxZQUFBQSxPQUFPLENBQUNDLElBQVIsQ0FBYSxxQkFBcUJDLElBQWxDO0FBQ0NuQyxZQUFBQSxXQUFELENBQXFCTyxTQUFyQixHQUFpQyxJQUFqQztBQUNBUCxZQUFBQSxXQUFXLENBQUNvQyxJQUFaLENBQWlCLFNBQWpCO0FBQ0FwQyxZQUFBQSxXQUFXLENBQUNxQyxJQUFaLENBQWlCLFdBQWpCLFNBQW9DcEMsaUJBQWlCLEVBQXJEO0FBQ0Q7QUFDRixTQVBEOztBQUFBO0FBQUE7QUFBQTtBQUFBO0FBUUQ7O0FBRUQsV0FBT0EsaUJBQWlCLEVBQXhCO0FBQ0QsRyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAnY29sb3JzJztcbmltcG9ydCB7IGFzeW5jT3JhIH0gZnJvbSAnQGVsZWN0cm9uLWZvcmdlL2FzeW5jLW9yYSc7XG5pbXBvcnQgeyBTdGFydE9wdGlvbnMsIEZvcmdlUGxhdGZvcm0sIEZvcmdlQXJjaCB9IGZyb20gJ0BlbGVjdHJvbi1mb3JnZS9zaGFyZWQtdHlwZXMnO1xuaW1wb3J0IHsgc3Bhd24sIENoaWxkUHJvY2VzcywgU3Bhd25PcHRpb25zIH0gZnJvbSAnY2hpbGRfcHJvY2Vzcyc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcblxuaW1wb3J0IHsgcmVhZE11dGF0ZWRQYWNrYWdlSnNvbiB9IGZyb20gJy4uL3V0aWwvcmVhZC1wYWNrYWdlLWpzb24nO1xuaW1wb3J0IHJlYnVpbGQgZnJvbSAnLi4vdXRpbC9yZWJ1aWxkJztcbmltcG9ydCByZXNvbHZlRGlyIGZyb20gJy4uL3V0aWwvcmVzb2x2ZS1kaXInO1xuaW1wb3J0IGdldEZvcmdlQ29uZmlnIGZyb20gJy4uL3V0aWwvZm9yZ2UtY29uZmlnJztcbmltcG9ydCB7IHJ1bkhvb2sgfSBmcm9tICcuLi91dGlsL2hvb2snO1xuaW1wb3J0IHsgZ2V0RWxlY3Ryb25WZXJzaW9uIH0gZnJvbSAnLi4vdXRpbC9lbGVjdHJvbi12ZXJzaW9uJztcblxuZXhwb3J0IHsgU3RhcnRPcHRpb25zIH07XG5cbmV4cG9ydCBkZWZhdWx0IGFzeW5jICh7XG4gIGRpciA9IHByb2Nlc3MuY3dkKCksXG4gIGFwcFBhdGggPSAnLicsXG4gIGludGVyYWN0aXZlID0gZmFsc2UsXG4gIGVuYWJsZUxvZ2dpbmcgPSBmYWxzZSxcbiAgYXJncyA9IFtdLFxuICBydW5Bc05vZGUgPSBmYWxzZSxcbiAgaW5zcGVjdCA9IGZhbHNlLFxufTogU3RhcnRPcHRpb25zKSA9PiB7XG4gIGFzeW5jT3JhLmludGVyYWN0aXZlID0gaW50ZXJhY3RpdmU7XG5cbiAgYXdhaXQgYXN5bmNPcmEoJ0xvY2F0aW5nIEFwcGxpY2F0aW9uJywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IHJlc29sdmVkRGlyID0gYXdhaXQgcmVzb2x2ZURpcihkaXIpO1xuICAgIGlmICghcmVzb2x2ZWREaXIpIHtcbiAgICAgIHRocm93ICdGYWlsZWQgdG8gbG9jYXRlIHN0YXJ0YWJsZSBFbGVjdHJvbiBhcHBsaWNhdGlvbic7XG4gICAgfVxuICAgIGRpciA9IHJlc29sdmVkRGlyO1xuICB9KTtcblxuICBjb25zdCBmb3JnZUNvbmZpZyA9IGF3YWl0IGdldEZvcmdlQ29uZmlnKGRpcik7XG4gIGNvbnN0IHBhY2thZ2VKU09OID0gYXdhaXQgcmVhZE11dGF0ZWRQYWNrYWdlSnNvbihkaXIsIGZvcmdlQ29uZmlnKTtcblxuICBpZiAoIXBhY2thZ2VKU09OLnZlcnNpb24pIHtcbiAgICB0aHJvdyBgUGxlYXNlIHNldCB5b3VyIGFwcGxpY2F0aW9uJ3MgJ3ZlcnNpb24nIGluICcke2Rpcn0vcGFja2FnZS5qc29uJy5gO1xuICB9XG5cbiAgYXdhaXQgcmVidWlsZChcbiAgICBkaXIsXG4gICAgYXdhaXQgZ2V0RWxlY3Ryb25WZXJzaW9uKGRpciwgcGFja2FnZUpTT04pLFxuICAgIHByb2Nlc3MucGxhdGZvcm0gYXMgRm9yZ2VQbGF0Zm9ybSxcbiAgICBwcm9jZXNzLmFyY2ggYXMgRm9yZ2VBcmNoLFxuICAgIGZvcmdlQ29uZmlnLmVsZWN0cm9uUmVidWlsZENvbmZpZyxcbiAgKTtcblxuICBhd2FpdCBydW5Ib29rKGZvcmdlQ29uZmlnLCAnZ2VuZXJhdGVBc3NldHMnKTtcblxuICBsZXQgbGFzdFNwYXduZWQ6IENoaWxkUHJvY2VzcyB8IG51bGwgPSBudWxsO1xuXG4gIGNvbnN0IGZvcmdlU3Bhd25XcmFwcGVyID0gYXN5bmMgKCkgPT4ge1xuICAgIGxhc3RTcGF3bmVkID0gYXdhaXQgZm9yZ2VTcGF3bigpO1xuICAgIC8vIFdoZW4gdGhlIGNoaWxkIGFwcCBpcyBjbG9zZWQgd2Ugc2hvdWxkIHN0b3AgbGlzdGVuaW5nIGZvciBzdGRpblxuICAgIGlmIChsYXN0U3Bhd25lZCkge1xuICAgICAgaWYgKGludGVyYWN0aXZlICYmIHByb2Nlc3Muc3RkaW4uaXNQYXVzZWQoKSkge1xuICAgICAgICBwcm9jZXNzLnN0ZGluLnJlc3VtZSgpO1xuICAgICAgfVxuICAgICAgbGFzdFNwYXduZWQub24oJ2V4aXQnLCAoKSA9PiB7XG4gICAgICAgIGlmICgobGFzdFNwYXduZWQgYXMgYW55KS5yZXN0YXJ0ZWQpIHJldHVybjtcblxuICAgICAgICBpZiAoIXByb2Nlc3Muc3RkaW4uaXNQYXVzZWQoKSkgcHJvY2Vzcy5zdGRpbi5wYXVzZSgpO1xuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmIChpbnRlcmFjdGl2ZSAmJiAhcHJvY2Vzcy5zdGRpbi5pc1BhdXNlZCgpKSB7XG4gICAgICAgIHByb2Nlc3Muc3RkaW4ucGF1c2UoKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGxhc3RTcGF3bmVkO1xuICB9O1xuXG4gIGNvbnN0IGZvcmdlU3Bhd24gPSBhc3luYyAoKSA9PiB7XG4gICAgbGV0IGVsZWN0cm9uRXhlY1BhdGg6IHN0cmluZyB8IG51bGwgPSBudWxsO1xuXG4gICAgLy8gSWYgYSBwbHVnaW4gaGFzIHRha2VuIG92ZXIgdGhlIHN0YXJ0IGNvbW1hbmQgbGV0J3Mgc3RvcCBoZXJlXG4gICAgY29uc3Qgc3Bhd25lZFBsdWdpbkNoaWxkID0gYXdhaXQgZm9yZ2VDb25maWcucGx1Z2luSW50ZXJmYWNlLm92ZXJyaWRlU3RhcnRMb2dpYyh7XG4gICAgICBkaXIsXG4gICAgICBhcHBQYXRoLFxuICAgICAgaW50ZXJhY3RpdmUsXG4gICAgICBlbmFibGVMb2dnaW5nLFxuICAgICAgYXJncyxcbiAgICAgIHJ1bkFzTm9kZSxcbiAgICAgIGluc3BlY3QsXG4gICAgfSk7XG4gICAgbGV0IHByZWZpeEFyZ3M6IHN0cmluZ1tdID0gW107XG4gICAgaWYgKHR5cGVvZiBzcGF3bmVkUGx1Z2luQ2hpbGQgPT09ICdzdHJpbmcnKSB7XG4gICAgICBlbGVjdHJvbkV4ZWNQYXRoID0gc3Bhd25lZFBsdWdpbkNoaWxkO1xuICAgIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheShzcGF3bmVkUGx1Z2luQ2hpbGQpKSB7XG4gICAgICBlbGVjdHJvbkV4ZWNQYXRoID0gc3Bhd25lZFBsdWdpbkNoaWxkWzBdO1xuICAgICAgcHJlZml4QXJncyA9IHNwYXduZWRQbHVnaW5DaGlsZC5zbGljZSgxKTtcbiAgICB9IGVsc2UgaWYgKHNwYXduZWRQbHVnaW5DaGlsZCkge1xuICAgICAgYXdhaXQgcnVuSG9vayhmb3JnZUNvbmZpZywgJ3Bvc3RTdGFydCcsIHNwYXduZWRQbHVnaW5DaGlsZCk7XG4gICAgICByZXR1cm4gc3Bhd25lZFBsdWdpbkNoaWxkO1xuICAgIH1cblxuICAgIGlmICghZWxlY3Ryb25FeGVjUGF0aCkge1xuICAgICAgZWxlY3Ryb25FeGVjUGF0aCA9IHJlcXVpcmUocGF0aC5yZXNvbHZlKGRpciwgJ25vZGVfbW9kdWxlcy9lbGVjdHJvbicpKTtcbiAgICB9XG5cbiAgICBjb25zdCBzcGF3bk9wdHMgPSB7XG4gICAgICBjd2Q6IGRpcixcbiAgICAgIHN0ZGlvOiAnaW5oZXJpdCcsXG4gICAgICBlbnY6IE9iamVjdC5hc3NpZ24oe30sIHByb2Nlc3MuZW52LCBlbmFibGVMb2dnaW5nID8ge1xuICAgICAgICBFTEVDVFJPTl9FTkFCTEVfTE9HR0lORzogJ3RydWUnLFxuICAgICAgICBFTEVDVFJPTl9FTkFCTEVfU1RBQ0tfRFVNUElORzogJ3RydWUnLFxuICAgICAgfSA6IHt9KSBhcyBOb2RlSlMuUHJvY2Vzc0VudixcbiAgICB9O1xuXG4gICAgaWYgKHJ1bkFzTm9kZSkge1xuICAgICAgc3Bhd25PcHRzLmVudi5FTEVDVFJPTl9SVU5fQVNfTk9ERSA9ICd0cnVlJztcbiAgICB9IGVsc2Uge1xuICAgICAgZGVsZXRlIHNwYXduT3B0cy5lbnYuRUxFQ1RST05fUlVOX0FTX05PREU7XG4gICAgfVxuXG4gICAgaWYgKGluc3BlY3QpIHtcbiAgICAgIGFyZ3MgPSBbJy0taW5zcGVjdCcgYXMgKHN0cmluZ3xudW1iZXIpXS5jb25jYXQoYXJncyk7XG4gICAgfVxuXG4gICAgbGV0IHNwYXduZWQhOiBDaGlsZFByb2Nlc3M7XG5cbiAgICBhd2FpdCBhc3luY09yYSgnTGF1bmNoaW5nIEFwcGxpY2F0aW9uJywgYXN5bmMgKCkgPT4ge1xuICAgICAgc3Bhd25lZCA9IHNwYXduKGVsZWN0cm9uRXhlY1BhdGghLCBwcmVmaXhBcmdzLmNvbmNhdChbYXBwUGF0aF0pLmNvbmNhdChhcmdzIGFzIHN0cmluZ1tdKSwgc3Bhd25PcHRzIGFzIFNwYXduT3B0aW9ucyk7XG4gICAgfSk7XG5cbiAgICBhd2FpdCBydW5Ib29rKGZvcmdlQ29uZmlnLCAncG9zdFN0YXJ0Jywgc3Bhd25lZCk7XG4gICAgcmV0dXJuIHNwYXduZWQ7XG4gIH07XG5cbiAgaWYgKGludGVyYWN0aXZlKSB7XG4gICAgcHJvY2Vzcy5zdGRpbi5vbignZGF0YScsIGFzeW5jIChkYXRhKSA9PiB7XG4gICAgICBpZiAoZGF0YS50b1N0cmluZygpLnRyaW0oKSA9PT0gJ3JzJyAmJiBsYXN0U3Bhd25lZCkge1xuICAgICAgICBjb25zb2xlLmluZm8oJ1xcblJlc3RhcnRpbmcgQXBwXFxuJy5jeWFuKTtcbiAgICAgICAgKGxhc3RTcGF3bmVkIGFzIGFueSkucmVzdGFydGVkID0gdHJ1ZTtcbiAgICAgICAgbGFzdFNwYXduZWQua2lsbCgnU0lHVEVSTScpO1xuICAgICAgICBsYXN0U3Bhd25lZC5lbWl0KCdyZXN0YXJ0ZWQnLCBhd2FpdCBmb3JnZVNwYXduV3JhcHBlcigpKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIHJldHVybiBmb3JnZVNwYXduV3JhcHBlcigpO1xufTtcbiJdfQ==