"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash.merge"));

var _asyncOra = require("@electron-forge/async-ora");

var _debug = _interopRequireDefault(require("debug"));

var _fsExtra = _interopRequireDefault(require("fs-extra"));

var _path = _interopRequireDefault(require("path"));

var _initGit = _interopRequireDefault(require("./init-scripts/init-git"));

var _initNpm = require("./init-scripts/init-npm");

var _electronVersion = require("../util/electron-version");

var _forgeConfig = require("../util/forge-config");

var _messages = require("../util/messages");

var _installDependencies = _interopRequireWildcard(require("../util/install-dependencies"));

var _readPackageJson = require("../util/read-package-json");

var _upgradeForgeConfig = _interopRequireWildcard(require("../util/upgrade-forge-config"));

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = Object.defineProperty && Object.getOwnPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : {}; if (desc.get || desc.set) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } } newObj.default = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _slicedToArray(arr, i) { return _arrayWithHoles(arr) || _iterableToArrayLimit(arr, i) || _nonIterableRest(); }

function _nonIterableRest() { throw new TypeError("Invalid attempt to destructure non-iterable instance"); }

function _iterableToArrayLimit(arr, i) { var _arr = []; var _n = true; var _d = false; var _e = undefined; try { for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i["return"] != null) _i["return"](); } finally { if (_d) throw _e; } } return _arr; }

function _arrayWithHoles(arr) { if (Array.isArray(arr)) return arr; }

function asyncGeneratorStep(gen, resolve, reject, _next, _throw, key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { Promise.resolve(value).then(_next, _throw); } }

function _asyncToGenerator(fn) { return function () { var self = this, args = arguments; return new Promise(function (resolve, reject) { var gen = fn.apply(self, args); function _next(value) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, "next", value); } function _throw(err) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, "throw", err); } _next(undefined); }); }; }

const d = (0, _debug.default)('electron-forge:import');

var _default =
/*#__PURE__*/
function () {
  var _ref = _asyncToGenerator(function* ({
    dir = process.cwd(),
    interactive = false,
    confirmImport,
    shouldContinueOnExisting,
    shouldRemoveDependency,
    shouldUpdateScript,
    outDir
  }) {
    const calculatedOutDir = outDir || 'out';
    _asyncOra.asyncOra.interactive = interactive;
    d(`Attempting to import project in: ${dir}`);

    if (!(yield _fsExtra.default.pathExists(dir)) || !(yield _fsExtra.default.pathExists(_path.default.resolve(dir, 'package.json')))) {
      throw `We couldn't find a project in: ${dir}`;
    } // eslint-disable-next-line max-len


    if (typeof confirmImport === 'function') {
      if (!(yield confirmImport())) {
        process.exit(0);
      }
    }

    yield (0, _initGit.default)(dir);
    const importDeps = [].concat(_initNpm.deps);
    let importDevDeps = [].concat(_initNpm.devDeps);
    let importExactDevDeps = [].concat(_initNpm.exactDevDeps);
    let packageJSON = yield (0, _readPackageJson.readRawPackageJson)(dir);

    if (packageJSON.config && packageJSON.config.forge) {
      if (packageJSON.config.forge.makers) {
        (0, _messages.warn)(interactive, 'It looks like this project is already configured for Electron Forge'.green);

        if (typeof shouldContinueOnExisting === 'function') {
          if (!(yield shouldContinueOnExisting())) {
            process.exit(0);
          }
        }
      } else if (typeof packageJSON.config.forge === 'string') {
        (0, _messages.warn)(interactive, "We can't tell if the Electron Forge config is compatible because it's in an external JavaScript file, not trying to convert it and continuing anyway".yellow);
      } else {
        d('Upgrading an Electron Forge < 6 project');
        packageJSON.config.forge = (0, _upgradeForgeConfig.default)(packageJSON.config.forge);
        importDevDeps = (0, _upgradeForgeConfig.updateUpgradedForgeDevDeps)(packageJSON, importDevDeps);
      }
    }

    packageJSON.dependencies = packageJSON.dependencies || {};
    packageJSON.devDependencies = packageJSON.devDependencies || {};

    var _updateElectronDepend = (0, _electronVersion.updateElectronDependency)(packageJSON, importDevDeps, importExactDevDeps);

    var _updateElectronDepend2 = _slicedToArray(_updateElectronDepend, 2);

    importDevDeps = _updateElectronDepend2[0];
    importExactDevDeps = _updateElectronDepend2[1];
    const keys = Object.keys(packageJSON.dependencies).concat(Object.keys(packageJSON.devDependencies));
    const buildToolPackages = {
      'electron-builder': 'provides mostly equivalent functionality',
      'electron-download': 'already uses this module as a transitive dependency',
      'electron-forge': 'replaced with @electron-forge/cli',
      'electron-installer-debian': 'already uses this module as a transitive dependency',
      'electron-installer-dmg': 'already uses this module as a transitive dependency',
      'electron-installer-flatpak': 'already uses this module as a transitive dependency',
      'electron-installer-redhat': 'already uses this module as a transitive dependency',
      'electron-osx-sign': 'already uses this module as a transitive dependency',
      'electron-packager': 'already uses this module as a transitive dependency',
      'electron-winstaller': 'already uses this module as a transitive dependency'
    };
    var _iteratorNormalCompletion = true;
    var _didIteratorError = false;
    var _iteratorError = undefined;

    try {
      for (var _iterator = keys[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
        const key = _step.value;

        if (buildToolPackages[key]) {
          const explanation = buildToolPackages[key]; // eslint-disable-next-line max-len

          let remove = true;

          if (typeof shouldRemoveDependency === 'function') {
            remove = yield shouldRemoveDependency(key, explanation);
          }

          if (remove) {
            delete packageJSON.dependencies[key];
            delete packageJSON.devDependencies[key];
          }
        }
      }
    } catch (err) {
      _didIteratorError = true;
      _iteratorError = err;
    } finally {
      try {
        if (!_iteratorNormalCompletion && _iterator.return != null) {
          _iterator.return();
        }
      } finally {
        if (_didIteratorError) {
          throw _iteratorError;
        }
      }
    }

    packageJSON.scripts = packageJSON.scripts || {};
    d('reading current scripts object:', packageJSON.scripts);

    const updatePackageScript =
    /*#__PURE__*/
    function () {
      var _ref2 = _asyncToGenerator(function* (scriptName, newValue) {
        if (packageJSON.scripts[scriptName] !== newValue) {
          // eslint-disable-next-line max-len
          let update = true;

          if (typeof shouldUpdateScript === 'function') {
            update = yield shouldUpdateScript(scriptName, newValue);
          }

          if (update) {
            packageJSON.scripts[scriptName] = newValue;
          }
        }
      });

      return function updatePackageScript(_x2, _x3) {
        return _ref2.apply(this, arguments);
      };
    }();

    yield updatePackageScript('start', 'electron-forge start');
    yield updatePackageScript('package', 'electron-forge package');
    yield updatePackageScript('make', 'electron-forge make');
    d('forgified scripts object:', packageJSON.scripts);

    const writeChanges =
    /*#__PURE__*/
    function () {
      var _ref3 = _asyncToGenerator(function* () {
        yield (0, _asyncOra.asyncOra)('Writing modified package.json file',
        /*#__PURE__*/
        _asyncToGenerator(function* () {
          yield _fsExtra.default.writeJson(_path.default.resolve(dir, 'package.json'), packageJSON, {
            spaces: 2
          });
        }));
      });

      return function writeChanges() {
        return _ref3.apply(this, arguments);
      };
    }();

    yield writeChanges();
    yield (0, _asyncOra.asyncOra)('Installing dependencies',
    /*#__PURE__*/
    _asyncToGenerator(function* () {
      d('deleting old dependencies forcefully');
      yield _fsExtra.default.remove(_path.default.resolve(dir, 'node_modules/.bin/electron'));
      yield _fsExtra.default.remove(_path.default.resolve(dir, 'node_modules/.bin/electron.cmd'));
      d('installing dependencies');
      yield (0, _installDependencies.default)(dir, importDeps);
      d('installing devDependencies');
      yield (0, _installDependencies.default)(dir, importDevDeps, _installDependencies.DepType.DEV);
      d('installing exactDevDependencies');
      yield (0, _installDependencies.default)(dir, importExactDevDeps, _installDependencies.DepType.DEV, _installDependencies.DepVersionRestriction.EXACT);
    }));
    packageJSON = yield (0, _readPackageJson.readRawPackageJson)(dir);

    if (!packageJSON.version) {
      (0, _messages.warn)(interactive, 'Please set the "version" in your application\'s package.json'.yellow);
    }

    packageJSON.config = packageJSON.config || {};
    const templatePackageJSON = yield (0, _readPackageJson.readRawPackageJson)(_path.default.resolve(__dirname, '../../tmpl'));

    if (packageJSON.config.forge) {
      if (typeof packageJSON.config.forge !== 'string') {
        packageJSON.config.forge = (0, _lodash.default)(templatePackageJSON.config.forge, packageJSON.config.forge);
      }
    } else {
      packageJSON.config.forge = templatePackageJSON.config.forge;
    }

    if (typeof packageJSON.config.forge !== 'string') {
      (0, _forgeConfig.setInitialForgeConfig)(packageJSON);
    }

    yield writeChanges();
    yield (0, _asyncOra.asyncOra)('Fixing .gitignore',
    /*#__PURE__*/
    _asyncToGenerator(function* () {
      if (yield _fsExtra.default.pathExists(_path.default.resolve(dir, '.gitignore'))) {
        const gitignore = yield _fsExtra.default.readFile(_path.default.resolve(dir, '.gitignore'));

        if (!gitignore.includes(calculatedOutDir)) {
          yield _fsExtra.default.writeFile(_path.default.resolve(dir, '.gitignore'), `${gitignore}\n${calculatedOutDir}/`);
        }
      }
    }));
    (0, _messages.info)(interactive, `

We have ATTEMPTED to convert your app to be in a format that electron-forge understands.

Thanks for using ${'"electron-forge"'.green}!!!`);
  });

  return function (_x) {
    return _ref.apply(this, arguments);
  };
}();

exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hcGkvaW1wb3J0LnRzIl0sIm5hbWVzIjpbImQiLCJkaXIiLCJwcm9jZXNzIiwiY3dkIiwiaW50ZXJhY3RpdmUiLCJjb25maXJtSW1wb3J0Iiwic2hvdWxkQ29udGludWVPbkV4aXN0aW5nIiwic2hvdWxkUmVtb3ZlRGVwZW5kZW5jeSIsInNob3VsZFVwZGF0ZVNjcmlwdCIsIm91dERpciIsImNhbGN1bGF0ZWRPdXREaXIiLCJhc3luY09yYSIsImZzIiwicGF0aEV4aXN0cyIsInBhdGgiLCJyZXNvbHZlIiwiZXhpdCIsImltcG9ydERlcHMiLCJjb25jYXQiLCJkZXBzIiwiaW1wb3J0RGV2RGVwcyIsImRldkRlcHMiLCJpbXBvcnRFeGFjdERldkRlcHMiLCJleGFjdERldkRlcHMiLCJwYWNrYWdlSlNPTiIsImNvbmZpZyIsImZvcmdlIiwibWFrZXJzIiwiZ3JlZW4iLCJ5ZWxsb3ciLCJkZXBlbmRlbmNpZXMiLCJkZXZEZXBlbmRlbmNpZXMiLCJrZXlzIiwiT2JqZWN0IiwiYnVpbGRUb29sUGFja2FnZXMiLCJrZXkiLCJleHBsYW5hdGlvbiIsInJlbW92ZSIsInNjcmlwdHMiLCJ1cGRhdGVQYWNrYWdlU2NyaXB0Iiwic2NyaXB0TmFtZSIsIm5ld1ZhbHVlIiwidXBkYXRlIiwid3JpdGVDaGFuZ2VzIiwid3JpdGVKc29uIiwic3BhY2VzIiwiRGVwVHlwZSIsIkRFViIsIkRlcFZlcnNpb25SZXN0cmljdGlvbiIsIkVYQUNUIiwidmVyc2lvbiIsInRlbXBsYXRlUGFja2FnZUpTT04iLCJfX2Rpcm5hbWUiLCJnaXRpZ25vcmUiLCJyZWFkRmlsZSIsImluY2x1ZGVzIiwid3JpdGVGaWxlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBRUEsTUFBTUEsQ0FBQyxHQUFHLG9CQUFNLHVC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OlsiaW1wb3J0IF9tZXJnZSBmcm9tICdsb2Rhc2gubWVyZ2UnO1xuaW1wb3J0IHsgYXN5bmNPcmEgfSBmcm9tICdAZWxlY3Ryb24tZm9yZ2UvYXN5bmMtb3JhJztcbmltcG9ydCBkZWJ1ZyBmcm9tICdkZWJ1Zyc7XG5pbXBvcnQgZnMgZnJvbSAnZnMtZXh0cmEnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5cbmltcG9ydCBpbml0R2l0IGZyb20gJy4vaW5pdC1zY3JpcHRzL2luaXQtZ2l0JztcbmltcG9ydCB7IGRlcHMsIGRldkRlcHMsIGV4YWN0RGV2RGVwcyB9IGZyb20gJy4vaW5pdC1zY3JpcHRzL2luaXQtbnBtJztcblxuaW1wb3J0IHsgdXBkYXRlRWxlY3Ryb25EZXBlbmRlbmN5IH0gZnJvbSAnLi4vdXRpbC9lbGVjdHJvbi12ZXJzaW9uJztcbmltcG9ydCB7IHNldEluaXRpYWxGb3JnZUNvbmZpZyB9IGZyb20gJy4uL3V0aWwvZm9yZ2UtY29uZmlnJztcbmltcG9ydCB7IGluZm8sIHdhcm4gfSBmcm9tICcuLi91dGlsL21lc3NhZ2VzJztcbmltcG9ydCBpbnN0YWxsRGVwTGlzdCwgeyBEZXBUeXBlLCBEZXBWZXJzaW9uUmVzdHJpY3Rpb24gfSBmcm9tICcuLi91dGlsL2luc3RhbGwtZGVwZW5kZW5jaWVzJztcbmltcG9ydCB7IHJlYWRSYXdQYWNrYWdlSnNvbiB9IGZyb20gJy4uL3V0aWwvcmVhZC1wYWNrYWdlLWpzb24nO1xuaW1wb3J0IHVwZ3JhZGVGb3JnZUNvbmZpZywgeyB1cGRhdGVVcGdyYWRlZEZvcmdlRGV2RGVwcyB9IGZyb20nLi4vdXRpbC91cGdyYWRlLWZvcmdlLWNvbmZpZyc7XG5cbmNvbnN0IGQgPSBkZWJ1ZygnZWxlY3Ryb24tZm9yZ2U6aW1wb3J0Jyk7XG5cbmV4cG9ydCBpbnRlcmZhY2UgSW1wb3J0T3B0aW9ucyB7XG4gIC8qKlxuICAgKiBUaGUgcGF0aCB0byB0aGUgYXBwIHRvIGJlIGltcG9ydGVkXG4gICAqL1xuICBkaXI/OiBzdHJpbmc7XG4gIC8qKlxuICAgKiBXaGV0aGVyIHRvIHVzZSBzZW5zaWJsZSBkZWZhdWx0cyBvciBwcm9tcHQgdGhlIHVzZXIgdmlzdWFsbHlcbiAgICovXG4gIGludGVyYWN0aXZlPzogYm9vbGVhbjtcbiAgLyoqXG4gICAqIEFuIGFzeW5jIGZ1bmN0aW9uIHRoYXQgcmV0dXJucyB0cnVlIG9yIGZhbHNlIGluIG9yZGVyIHRvIGNvbmZpcm0gdGhlIHN0YXJ0XG4gICAqIG9mIGltcG9ydGluZ1xuICAgKi9cbiAgY29uZmlybUltcG9ydD86ICgpID0+IFByb21pc2U8Ym9vbGVhbj47XG4gIC8qKlxuICAgKiBBbiBhc3luYyBmdW5jdGlvbiB0aGF0IHJldHVybnMgd2hldGhlciB0aGUgaW1wb3J0IHNob3VsZCBjb250aW51ZSBpZiBpdFxuICAgKiBsb29rcyBsaWtlIGEgZm9yZ2UgcHJvamVjdCBhbHJlYWR5XG4gICAqL1xuICBzaG91bGRDb250aW51ZU9uRXhpc3Rpbmc/OiAoKSA9PiBQcm9taXNlPGJvb2xlYW4+O1xuICAvKipcbiAgICogQW4gYXN5bmMgZnVuY3Rpb24gdGhhdCByZXR1cm5zIHdoZXRoZXIgdGhlIGdpdmVuIGRlcGVuZGVuY3kgc2hvdWxkIGJlIHJlbW92ZWRcbiAgICovXG4gIHNob3VsZFJlbW92ZURlcGVuZGVuY3k/OiAoZGVwZW5kZW5jeTogc3RyaW5nLCBleHBsYW5hdGlvbjogc3RyaW5nKSA9PiBQcm9taXNlPGJvb2xlYW4+O1xuICAvKipcbiAgICogQW4gYXN5bmMgZnVuY3Rpb24gdGhhdCByZXR1cm5zIHdoZXRoZXIgdGhlIGdpdmVuIHNjcmlwdCBzaG91bGQgYmUgb3ZlcnJpZGRlbiB3aXRoIGEgZm9yZ2Ugb25lXG4gICAqL1xuICBzaG91bGRVcGRhdGVTY3JpcHQ/OiAoc2NyaXB0TmFtZTogc3RyaW5nLCBuZXdWYWx1ZTogc3RyaW5nKSA9PiBQcm9taXNlPGJvb2xlYW4+O1xuICAvKipcbiAgICogVGhlIHBhdGggdG8gdGhlIGRpcmVjdG9yeSBjb250YWluaW5nIGdlbmVyYXRlZCBkaXN0cmlidXRhYmxlc1xuICAgKi9cbiAgb3V0RGlyPzogc3RyaW5nO1xufVxuXG5leHBvcnQgZGVmYXVsdCBhc3luYyAoe1xuICBkaXIgPSBwcm9jZXNzLmN3ZCgpLFxuICBpbnRlcmFjdGl2ZSA9IGZhbHNlLFxuICBjb25maXJtSW1wb3J0LFxuICBzaG91bGRDb250aW51ZU9uRXhpc3RpbmcsXG4gIHNob3VsZFJlbW92ZURlcGVuZGVuY3ksXG4gIHNob3VsZFVwZGF0ZVNjcmlwdCxcbiAgb3V0RGlyLFxufTogSW1wb3J0T3B0aW9ucykgPT4ge1xuICBjb25zdCBjYWxjdWxhdGVkT3V0RGlyID0gb3V0RGlyIHx8ICdvdXQnO1xuICBhc3luY09yYS5pbnRlcmFjdGl2ZSA9IGludGVyYWN0aXZlO1xuXG4gIGQoYEF0dGVtcHRpbmcgdG8gaW1wb3J0IHByb2plY3QgaW46ICR7ZGlyfWApO1xuICBpZiAoIWF3YWl0IGZzLnBhdGhFeGlzdHMoZGlyKSB8fCAhYXdhaXQgZnMucGF0aEV4aXN0cyhwYXRoLnJlc29sdmUoZGlyLCAncGFja2FnZS5qc29uJykpKSB7XG4gICAgdGhyb3cgYFdlIGNvdWxkbid0IGZpbmQgYSBwcm9qZWN0IGluOiAke2Rpcn1gO1xuICB9XG5cbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG1heC1sZW5cbiAgaWYgKHR5cGVvZiBjb25maXJtSW1wb3J0ID09PSAnZnVuY3Rpb24nKSB7XG4gICAgaWYgKCFhd2FpdCBjb25maXJtSW1wb3J0KCkpIHtcbiAgICAgIHByb2Nlc3MuZXhpdCgwKTtcbiAgICB9XG4gIH1cblxuICBhd2FpdCBpbml0R2l0KGRpcik7XG5cbiAgY29uc3QgaW1wb3J0RGVwcyA9IChbXSBhcyBzdHJpbmdbXSkuY29uY2F0KGRlcHMpO1xuICBsZXQgaW1wb3J0RGV2RGVwcyA9IChbXSBhcyBzdHJpbmdbXSkuY29uY2F0KGRldkRlcHMpO1xuICBsZXQgaW1wb3J0RXhhY3REZXZEZXBzID0gKFtdIGFzIHN0cmluZ1tdKS5jb25jYXQoZXhhY3REZXZEZXBzKTtcblxuICBsZXQgcGFja2FnZUpTT04gPSBhd2FpdCByZWFkUmF3UGFja2FnZUpzb24oZGlyKTtcbiAgaWYgKHBhY2thZ2VKU09OLmNvbmZpZyAmJiBwYWNrYWdlSlNPTi5jb25maWcuZm9yZ2UpIHtcbiAgICBpZiAocGFja2FnZUpTT04uY29uZmlnLmZvcmdlLm1ha2Vycykge1xuICAgICAgd2FybihpbnRlcmFjdGl2ZSwgJ0l0IGxvb2tzIGxpa2UgdGhpcyBwcm9qZWN0IGlzIGFscmVhZHkgY29uZmlndXJlZCBmb3IgRWxlY3Ryb24gRm9yZ2UnLmdyZWVuKTtcbiAgICAgIGlmICh0eXBlb2Ygc2hvdWxkQ29udGludWVPbkV4aXN0aW5nID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgIGlmICghYXdhaXQgc2hvdWxkQ29udGludWVPbkV4aXN0aW5nKCkpIHtcbiAgICAgICAgICBwcm9jZXNzLmV4aXQoMCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9IGVsc2UgaWYgKHR5cGVvZiBwYWNrYWdlSlNPTi5jb25maWcuZm9yZ2UgPT09ICdzdHJpbmcnKSB7XG4gICAgICB3YXJuKGludGVyYWN0aXZlLCBcIldlIGNhbid0IHRlbGwgaWYgdGhlIEVsZWN0cm9uIEZvcmdlIGNvbmZpZyBpcyBjb21wYXRpYmxlIGJlY2F1c2UgaXQncyBpbiBhbiBleHRlcm5hbCBKYXZhU2NyaXB0IGZpbGUsIG5vdCB0cnlpbmcgdG8gY29udmVydCBpdCBhbmQgY29udGludWluZyBhbnl3YXlcIi55ZWxsb3cpO1xuICAgIH0gZWxzZSB7XG4gICAgICBkKCdVcGdyYWRpbmcgYW4gRWxlY3Ryb24gRm9yZ2UgPCA2IHByb2plY3QnKTtcbiAgICAgIHBhY2thZ2VKU09OLmNvbmZpZy5mb3JnZSA9IHVwZ3JhZGVGb3JnZUNvbmZpZyhwYWNrYWdlSlNPTi5jb25maWcuZm9yZ2UpO1xuICAgICAgaW1wb3J0RGV2RGVwcyA9IHVwZGF0ZVVwZ3JhZGVkRm9yZ2VEZXZEZXBzKHBhY2thZ2VKU09OLCBpbXBvcnREZXZEZXBzKTtcbiAgICB9XG4gIH1cblxuICBwYWNrYWdlSlNPTi5kZXBlbmRlbmNpZXMgPSBwYWNrYWdlSlNPTi5kZXBlbmRlbmNpZXMgfHwge307XG4gIHBhY2thZ2VKU09OLmRldkRlcGVuZGVuY2llcyA9IHBhY2thZ2VKU09OLmRldkRlcGVuZGVuY2llcyB8fCB7fTtcblxuICBbaW1wb3J0RGV2RGVwcywgaW1wb3J0RXhhY3REZXZEZXBzXSA9IHVwZGF0ZUVsZWN0cm9uRGVwZW5kZW5jeShwYWNrYWdlSlNPTiwgaW1wb3J0RGV2RGVwcywgaW1wb3J0RXhhY3REZXZEZXBzKTtcblxuICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXMocGFja2FnZUpTT04uZGVwZW5kZW5jaWVzKS5jb25jYXQoT2JqZWN0LmtleXMocGFja2FnZUpTT04uZGV2RGVwZW5kZW5jaWVzKSk7XG4gIGNvbnN0IGJ1aWxkVG9vbFBhY2thZ2VzOiB7XG4gICAgW2tleTogc3RyaW5nXTogc3RyaW5nIHwgdW5kZWZpbmVkO1xuICB9ID0ge1xuICAgICdlbGVjdHJvbi1idWlsZGVyJzogJ3Byb3ZpZGVzIG1vc3RseSBlcXVpdmFsZW50IGZ1bmN0aW9uYWxpdHknLFxuICAgICdlbGVjdHJvbi1kb3dubG9hZCc6ICdhbHJlYWR5IHVzZXMgdGhpcyBtb2R1bGUgYXMgYSB0cmFuc2l0aXZlIGRlcGVuZGVuY3knLFxuICAgICdlbGVjdHJvbi1mb3JnZSc6ICdyZXBsYWNlZCB3aXRoIEBlbGVjdHJvbi1mb3JnZS9jbGknLFxuICAgICdlbGVjdHJvbi1pbnN0YWxsZXItZGViaWFuJzogJ2FscmVhZHkgdXNlcyB0aGlzIG1vZHVsZSBhcyBhIHRyYW5zaXRpdmUgZGVwZW5kZW5jeScsXG4gICAgJ2VsZWN0cm9uLWluc3RhbGxlci1kbWcnOiAnYWxyZWFkeSB1c2VzIHRoaXMgbW9kdWxlIGFzIGEgdHJhbnNpdGl2ZSBkZXBlbmRlbmN5JyxcbiAgICAnZWxlY3Ryb24taW5zdGFsbGVyLWZsYXRwYWsnOiAnYWxyZWFkeSB1c2VzIHRoaXMgbW9kdWxlIGFzIGEgdHJhbnNpdGl2ZSBkZXBlbmRlbmN5JyxcbiAgICAnZWxlY3Ryb24taW5zdGFsbGVyLXJlZGhhdCc6ICdhbHJlYWR5IHVzZXMgdGhpcyBtb2R1bGUgYXMgYSB0cmFuc2l0aXZlIGRlcGVuZGVuY3knLFxuICAgICdlbGVjdHJvbi1vc3gtc2lnbic6ICdhbHJlYWR5IHVzZXMgdGhpcyBtb2R1bGUgYXMgYSB0cmFuc2l0aXZlIGRlcGVuZGVuY3knLFxuICAgICdlbGVjdHJvbi1wYWNrYWdlcic6ICdhbHJlYWR5IHVzZXMgdGhpcyBtb2R1bGUgYXMgYSB0cmFuc2l0aXZlIGRlcGVuZGVuY3knLFxuICAgICdlbGVjdHJvbi13aW5zdGFsbGVyJzogJ2FscmVhZHkgdXNlcyB0aGlzIG1vZHVsZSBhcyBhIHRyYW5zaXRpdmUgZGVwZW5kZW5jeScsXG4gIH07XG5cbiAgZm9yIChjb25zdCBrZXkgb2Yga2V5cykge1xuICAgIGlmIChidWlsZFRvb2xQYWNrYWdlc1trZXldKSB7XG4gICAgICBjb25zdCBleHBsYW5hdGlvbiA9IGJ1aWxkVG9vbFBhY2thZ2VzW2tleV0hO1xuICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG1heC1sZW5cbiAgICAgIGxldCByZW1vdmUgPSB0cnVlO1xuICAgICAgaWYgKHR5cGVvZiBzaG91bGRSZW1vdmVEZXBlbmRlbmN5ID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgIHJlbW92ZSA9IGF3YWl0IHNob3VsZFJlbW92ZURlcGVuZGVuY3koa2V5LCBleHBsYW5hdGlvbik7XG4gICAgICB9XG5cbiAgICAgIGlmIChyZW1vdmUpIHtcbiAgICAgICAgZGVsZXRlIHBhY2thZ2VKU09OLmRlcGVuZGVuY2llc1trZXldO1xuICAgICAgICBkZWxldGUgcGFja2FnZUpTT04uZGV2RGVwZW5kZW5jaWVzW2tleV07XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcGFja2FnZUpTT04uc2NyaXB0cyA9IHBhY2thZ2VKU09OLnNjcmlwdHMgfHwge307XG4gIGQoJ3JlYWRpbmcgY3VycmVudCBzY3JpcHRzIG9iamVjdDonLCBwYWNrYWdlSlNPTi5zY3JpcHRzKTtcblxuICBjb25zdCB1cGRhdGVQYWNrYWdlU2NyaXB0ID0gYXN5bmMgKHNjcmlwdE5hbWU6IHN0cmluZywgbmV3VmFsdWU6IHN0cmluZykgPT4ge1xuICAgIGlmIChwYWNrYWdlSlNPTi5zY3JpcHRzW3NjcmlwdE5hbWVdICE9PSBuZXdWYWx1ZSkge1xuICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG1heC1sZW5cbiAgICAgIGxldCB1cGRhdGUgPSB0cnVlO1xuICAgICAgaWYgKHR5cGVvZiBzaG91bGRVcGRhdGVTY3JpcHQgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgdXBkYXRlID0gYXdhaXQgc2hvdWxkVXBkYXRlU2NyaXB0KHNjcmlwdE5hbWUsIG5ld1ZhbHVlKTtcbiAgICAgIH1cbiAgICAgIGlmICh1cGRhdGUpIHtcbiAgICAgICAgcGFja2FnZUpTT04uc2NyaXB0c1tzY3JpcHROYW1lXSA9IG5ld1ZhbHVlO1xuICAgICAgfVxuICAgIH1cbiAgfTtcblxuICBhd2FpdCB1cGRhdGVQYWNrYWdlU2NyaXB0KCdzdGFydCcsICdlbGVjdHJvbi1mb3JnZSBzdGFydCcpO1xuICBhd2FpdCB1cGRhdGVQYWNrYWdlU2NyaXB0KCdwYWNrYWdlJywgJ2VsZWN0cm9uLWZvcmdlIHBhY2thZ2UnKTtcbiAgYXdhaXQgdXBkYXRlUGFja2FnZVNjcmlwdCgnbWFrZScsICdlbGVjdHJvbi1mb3JnZSBtYWtlJyk7XG5cbiAgZCgnZm9yZ2lmaWVkIHNjcmlwdHMgb2JqZWN0OicsIHBhY2thZ2VKU09OLnNjcmlwdHMpO1xuXG4gIGNvbnN0IHdyaXRlQ2hhbmdlcyA9IGFzeW5jICgpID0+IHtcbiAgICBhd2FpdCBhc3luY09yYSgnV3JpdGluZyBtb2RpZmllZCBwYWNrYWdlLmpzb24gZmlsZScsIGFzeW5jICgpID0+IHtcbiAgICAgIGF3YWl0IGZzLndyaXRlSnNvbihwYXRoLnJlc29sdmUoZGlyLCAncGFja2FnZS5qc29uJyksIHBhY2thZ2VKU09OLCB7IHNwYWNlczogMiB9KTtcbiAgICB9KTtcbiAgfTtcblxuICBhd2FpdCB3cml0ZUNoYW5nZXMoKTtcblxuICBhd2FpdCBhc3luY09yYSgnSW5zdGFsbGluZyBkZXBlbmRlbmNpZXMnLCBhc3luYyAoKSA9PiB7XG4gICAgZCgnZGVsZXRpbmcgb2xkIGRlcGVuZGVuY2llcyBmb3JjZWZ1bGx5Jyk7XG4gICAgYXdhaXQgZnMucmVtb3ZlKHBhdGgucmVzb2x2ZShkaXIsICdub2RlX21vZHVsZXMvLmJpbi9lbGVjdHJvbicpKTtcbiAgICBhd2FpdCBmcy5yZW1vdmUocGF0aC5yZXNvbHZlKGRpciwgJ25vZGVfbW9kdWxlcy8uYmluL2VsZWN0cm9uLmNtZCcpKTtcblxuICAgIGQoJ2luc3RhbGxpbmcgZGVwZW5kZW5jaWVzJyk7XG4gICAgYXdhaXQgaW5zdGFsbERlcExpc3QoZGlyLCBpbXBvcnREZXBzKTtcblxuICAgIGQoJ2luc3RhbGxpbmcgZGV2RGVwZW5kZW5jaWVzJyk7XG4gICAgYXdhaXQgaW5zdGFsbERlcExpc3QoZGlyLCBpbXBvcnREZXZEZXBzLCBEZXBUeXBlLkRFVik7XG5cbiAgICBkKCdpbnN0YWxsaW5nIGV4YWN0RGV2RGVwZW5kZW5jaWVzJyk7XG4gICAgYXdhaXQgaW5zdGFsbERlcExpc3QoZGlyLCBpbXBvcnRFeGFjdERldkRlcHMsIERlcFR5cGUuREVWLCBEZXBWZXJzaW9uUmVzdHJpY3Rpb24uRVhBQ1QpO1xuICB9KTtcblxuICBwYWNrYWdlSlNPTiA9IGF3YWl0IHJlYWRSYXdQYWNrYWdlSnNvbihkaXIpO1xuXG4gIGlmICghcGFja2FnZUpTT04udmVyc2lvbikge1xuICAgIHdhcm4oaW50ZXJhY3RpdmUsICdQbGVhc2Ugc2V0IHRoZSBcInZlcnNpb25cIiBpbiB5b3VyIGFwcGxpY2F0aW9uXFwncyBwYWNrYWdlLmpzb24nLnllbGxvdyk7XG4gIH1cblxuICBwYWNrYWdlSlNPTi5jb25maWcgPSBwYWNrYWdlSlNPTi5jb25maWcgfHwge307XG4gIGNvbnN0IHRlbXBsYXRlUGFja2FnZUpTT04gPSBhd2FpdCByZWFkUmF3UGFja2FnZUpzb24ocGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJy4uLy4uL3RtcGwnKSk7XG4gIGlmIChwYWNrYWdlSlNPTi5jb25maWcuZm9yZ2UpIHtcbiAgICBpZiAodHlwZW9mIHBhY2thZ2VKU09OLmNvbmZpZy5mb3JnZSAhPT0gJ3N0cmluZycpIHtcbiAgICAgIHBhY2thZ2VKU09OLmNvbmZpZy5mb3JnZSA9IF9tZXJnZSh0ZW1wbGF0ZVBhY2thZ2VKU09OLmNvbmZpZy5mb3JnZSwgcGFja2FnZUpTT04uY29uZmlnLmZvcmdlKTtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgcGFja2FnZUpTT04uY29uZmlnLmZvcmdlID0gdGVtcGxhdGVQYWNrYWdlSlNPTi5jb25maWcuZm9yZ2U7XG4gIH1cblxuICBpZiAodHlwZW9mIHBhY2thZ2VKU09OLmNvbmZpZy5mb3JnZSAhPT0gJ3N0cmluZycpIHtcbiAgICBzZXRJbml0aWFsRm9yZ2VDb25maWcocGFja2FnZUpTT04pO1xuICB9XG5cbiAgYXdhaXQgd3JpdGVDaGFuZ2VzKCk7XG5cbiAgYXdhaXQgYXN5bmNPcmEoJ0ZpeGluZyAuZ2l0aWdub3JlJywgYXN5bmMgKCkgPT4ge1xuICAgIGlmIChhd2FpdCBmcy5wYXRoRXhpc3RzKHBhdGgucmVzb2x2ZShkaXIsICcuZ2l0aWdub3JlJykpKSB7XG4gICAgICBjb25zdCBnaXRpZ25vcmUgPSBhd2FpdCBmcy5yZWFkRmlsZShwYXRoLnJlc29sdmUoZGlyLCAnLmdpdGlnbm9yZScpKTtcbiAgICAgIGlmICghZ2l0aWdub3JlLmluY2x1ZGVzKGNhbGN1bGF0ZWRPdXREaXIpKSB7XG4gICAgICAgIGF3YWl0IGZzLndyaXRlRmlsZShwYXRoLnJlc29sdmUoZGlyLCAnLmdpdGlnbm9yZScpLCBgJHtnaXRpZ25vcmV9XFxuJHtjYWxjdWxhdGVkT3V0RGlyfS9gKTtcbiAgICAgIH1cbiAgICB9XG4gIH0pO1xuXG4gIGluZm8oaW50ZXJhY3RpdmUsIGBcblxuV2UgaGF2ZSBBVFRFTVBURUQgdG8gY29udmVydCB5b3VyIGFwcCB0byBiZSBpbiBhIGZvcm1hdCB0aGF0IGVsZWN0cm9uLWZvcmdlIHVuZGVyc3RhbmRzLlxuXG5UaGFua3MgZm9yIHVzaW5nICR7J1wiZWxlY3Ryb24tZm9yZ2VcIicuZ3JlZW59ISEhYCk7XG59O1xuIl19