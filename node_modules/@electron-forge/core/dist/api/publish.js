"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

require("colors");

var _asyncOra = require("@electron-forge/async-ora");

var _debug = _interopRequireDefault(require("debug"));

var _fsExtra = _interopRequireDefault(require("fs-extra"));

var _path = _interopRequireDefault(require("path"));

var _forgeConfig = _interopRequireDefault(require("../util/forge-config"));

var _readPackageJson = require("../util/read-package-json");

var _resolveDir = _interopRequireDefault(require("../util/resolve-dir"));

var _publishState = _interopRequireDefault(require("../util/publish-state"));

var _outDir = _interopRequireDefault(require("../util/out-dir"));

var _make = _interopRequireDefault(require("./make"));

var _requireSearch = _interopRequireDefault(require("../util/require-search"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function asyncGeneratorStep(gen, resolve, reject, _next, _throw, key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { Promise.resolve(value).then(_next, _throw); } }

function _asyncToGenerator(fn) { return function () { var self = this, args = arguments; return new Promise(function (resolve, reject) { var gen = fn.apply(self, args); function _next(value) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, "next", value); } function _throw(err) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, "throw", err); } _next(undefined); }); }; }

const d = (0, _debug.default)('electron-forge:publish');

const publish =
/*#__PURE__*/
function () {
  var _ref = _asyncToGenerator(function* ({
    dir = process.cwd(),
    interactive = false,
    makeOptions = {},
    publishTargets = undefined,
    dryRun = false,
    dryRunResume = false,
    makeResults = undefined,
    outDir
  }) {
    _asyncOra.asyncOra.interactive = interactive;

    if (dryRun && dryRunResume) {
      throw 'Can\'t dry run and resume a dry run at the same time';
    }

    if (dryRunResume && makeResults) {
      throw 'Can\'t resume a dry run and use the provided makeResults at the same time';
    }

    const forgeConfig = yield (0, _forgeConfig.default)(dir);
    let packageJSON = yield (0, _readPackageJson.readMutatedPackageJson)(dir, forgeConfig);
    const calculatedOutDir = outDir || (0, _outDir.default)(dir, forgeConfig);

    const dryRunDir = _path.default.resolve(calculatedOutDir, 'publish-dry-run');

    if (dryRunResume) {
      d('attempting to resume from dry run');
      const publishes = yield _publishState.default.loadFromDirectory(dryRunDir, dir);
      var _iteratorNormalCompletion = true;
      var _didIteratorError = false;
      var _iteratorError = undefined;

      try {
        for (var _iterator = publishes[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
          const publishStates = _step.value;
          d('publishing for given state set');
          yield publish({
            dir,
            interactive,
            publishTargets,
            makeOptions,
            dryRun: false,
            dryRunResume: false,
            makeResults: publishStates.map(({
              state
            }) => state)
          });
        }
      } catch (err) {
        _didIteratorError = true;
        _iteratorError = err;
      } finally {
        try {
          if (!_iteratorNormalCompletion && _iterator.return != null) {
            _iterator.return();
          }
        } finally {
          if (_didIteratorError) {
            throw _iteratorError;
          }
        }
      }

      return;
    }

    if (!makeResults) {
      d('triggering make');
      makeResults = yield (0, _make.default)(Object.assign({
        dir,
        interactive
      }, makeOptions));
    } else {
      // Restore values from dry run
      d('restoring publish settings from dry run');
      var _iteratorNormalCompletion2 = true;
      var _didIteratorError2 = false;
      var _iteratorError2 = undefined;

      try {
        for (var _iterator2 = makeResults[Symbol.iterator](), _step2; !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
          const makeResult = _step2.value;
          packageJSON = makeResult.packageJSON;
          makeOptions.platform = makeResult.platform;
          makeOptions.arch = makeResult.arch;
          var _iteratorNormalCompletion3 = true;
          var _didIteratorError3 = false;
          var _iteratorError3 = undefined;

          try {
            for (var _iterator3 = makeResult.artifacts[Symbol.iterator](), _step3; !(_iteratorNormalCompletion3 = (_step3 = _iterator3.next()).done); _iteratorNormalCompletion3 = true) {
              const makePath = _step3.value;

              if (!(yield _fsExtra.default.pathExists(makePath))) {
                throw `Attempted to resume a dry run but an artifact (${makePath}) could not be found`;
              }
            }
          } catch (err) {
            _didIteratorError3 = true;
            _iteratorError3 = err;
          } finally {
            try {
              if (!_iteratorNormalCompletion3 && _iterator3.return != null) {
                _iterator3.return();
              }
            } finally {
              if (_didIteratorError3) {
                throw _iteratorError3;
              }
            }
          }
        }
      } catch (err) {
        _didIteratorError2 = true;
        _iteratorError2 = err;
      } finally {
        try {
          if (!_iteratorNormalCompletion2 && _iterator2.return != null) {
            _iterator2.return();
          }
        } finally {
          if (_didIteratorError2) {
            throw _iteratorError2;
          }
        }
      }
    }

    if (dryRun) {
      d('saving results of make in dry run state', makeResults);
      yield _fsExtra.default.remove(dryRunDir);
      yield _publishState.default.saveToDirectory(dryRunDir, makeResults, dir);
      return;
    }

    const resolvedDir = yield (0, _resolveDir.default)(dir);

    if (!resolvedDir) {
      throw 'Failed to locate publishable Electron application';
    }

    dir = resolvedDir;
    const testPlatform = makeOptions.platform || process.platform;

    if (!publishTargets) {
      publishTargets = forgeConfig.publishers || []; // .filter(publisher => (typeof publisher !== 'string' && publisher.platforms) ? publisher.platforms.indexOf(testPlatform) !== -1 : true);
    }

    publishTargets = publishTargets.map(target => {
      if (typeof target === 'string') {
        return (forgeConfig.publishers || []).find(p => {
          if (typeof p === 'string') return false;
          if (p.__isElectronForgePublisher) return false;
          return p.name === target;
        }) || {
          name: target
        };
      }

      return target;
    });
    var _iteratorNormalCompletion4 = true;
    var _didIteratorError4 = false;
    var _iteratorError4 = undefined;

    try {
      for (var _iterator4 = publishTargets[Symbol.iterator](), _step4; !(_iteratorNormalCompletion4 = (_step4 = _iterator4.next()).done); _iteratorNormalCompletion4 = true) {
        const publishTarget = _step4.value;
        let publisher;

        if (publishTarget.__isElectronForgePublisher) {
          publisher = publishTarget;
        } else {
          const resolvablePublishTarget = publishTarget;
          let PublisherClass;
          yield (0, _asyncOra.asyncOra)(`Resolving publish target: ${`${resolvablePublishTarget.name}`.cyan}`,
          /*#__PURE__*/
          _asyncToGenerator(function* () {
            // eslint-disable-line no-loop-func
            PublisherClass = (0, _requireSearch.default)(dir, [resolvablePublishTarget.name]);

            if (!PublisherClass) {
              throw `Could not find a publish target with the name: ${resolvablePublishTarget.name}`;
            }
          }));
          publisher = new PublisherClass(resolvablePublishTarget.config || {}, resolvablePublishTarget.platforms);
        }

        yield publisher.publish({
          dir,
          makeResults,
          forgeConfig
        });
      }
    } catch (err) {
      _didIteratorError4 = true;
      _iteratorError4 = err;
    } finally {
      try {
        if (!_iteratorNormalCompletion4 && _iterator4.return != null) {
          _iterator4.return();
        }
      } finally {
        if (_didIteratorError4) {
          throw _iteratorError4;
        }
      }
    }
  });

  return function publish(_x) {
    return _ref.apply(this, arguments);
  };
}();

var _default = publish;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hcGkvcHVibGlzaC50cyJdLCJuYW1lcyI6WyJkIiwicHVibGlzaCIsImRpciIsInByb2Nlc3MiLCJjd2QiLCJpbnRlcmFjdGl2ZSIsIm1ha2VPcHRpb25zIiwicHVibGlzaFRhcmdldHMiLCJ1bmRlZmluZWQiLCJkcnlSdW4iLCJkcnlSdW5SZXN1bWUiLCJtYWtlUmVzdWx0cyIsIm91dERpciIsImFzeW5jT3JhIiwiZm9yZ2VDb25maWciLCJwYWNrYWdlSlNPTiIsImNhbGN1bGF0ZWRPdXREaXIiLCJkcnlSdW5EaXIiLCJwYXRoIiwicmVzb2x2ZSIsInB1Ymxpc2hlcyIsIlB1Ymxpc2hTdGF0ZSIsImxvYWRGcm9tRGlyZWN0b3J5IiwicHVibGlzaFN0YXRlcyIsIm1hcCIsInN0YXRlIiwiT2JqZWN0IiwiYXNzaWduIiwibWFrZVJlc3VsdCIsInBsYXRmb3JtIiwiYXJjaCIsImFydGlmYWN0cyIsIm1ha2VQYXRoIiwiZnMiLCJwYXRoRXhpc3RzIiwicmVtb3ZlIiwic2F2ZVRvRGlyZWN0b3J5IiwicmVzb2x2ZWREaXIiLCJ0ZXN0UGxhdGZvcm0iLCJwdWJsaXNoZXJzIiwidGFyZ2V0IiwiZmluZCIsInAiLCJfX2lzRWxlY3Ryb25Gb3JnZVB1Ymxpc2hlciIsIm5hbWUiLCJwdWJsaXNoVGFyZ2V0IiwicHVibGlzaGVyIiwicmVzb2x2YWJsZVB1Ymxpc2hUYXJnZXQiLCJQdWJsaXNoZXJDbGFzcyIsImN5YW4iLCJjb25maWciLCJwbGF0Zm9ybXMiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUdBOztBQUNBOztBQUNBOztBQUVBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBOztBQUNBOzs7Ozs7OztBQUVBLE1BQU1BLENBQUMsR0FBRyxvQkFBTSx3QkFBTixDQUFWOztBQXdDQSxNQUFNQyxPQUFPO0FBQUE7QUFBQTtBQUFBLCtCQUFHLFdBQU87QUFDckJDLElBQUFBLEdBQUcsR0FBR0MsT0FBTyxDQUFDQyxHQUFS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O0FBQUE7QUFBQTtBQUFBLEdBQWI7O2VBd0hlQSxPIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICdjb2xvcnMnO1xuaW1wb3J0IHsgYXN5bmNPcmEgfSBmcm9tICdAZWxlY3Ryb24tZm9yZ2UvYXN5bmMtb3JhJztcbmltcG9ydCB7IElGb3JnZVJlc29sdmFibGVQdWJsaXNoZXIsIElGb3JnZVB1Ymxpc2hlciwgRm9yZ2VNYWtlUmVzdWx0LCBGb3JnZVBsYXRmb3JtIH0gZnJvbSAnQGVsZWN0cm9uLWZvcmdlL3NoYXJlZC10eXBlcyc7XG5pbXBvcnQgUHVibGlzaGVyQmFzZSBmcm9tICdAZWxlY3Ryb24tZm9yZ2UvcHVibGlzaGVyLWJhc2UnO1xuaW1wb3J0IGRlYnVnIGZyb20gJ2RlYnVnJztcbmltcG9ydCBmcyBmcm9tICdmcy1leHRyYSc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcblxuaW1wb3J0IGdldEZvcmdlQ29uZmlnIGZyb20gJy4uL3V0aWwvZm9yZ2UtY29uZmlnJztcbmltcG9ydCB7IHJlYWRNdXRhdGVkUGFja2FnZUpzb24gfSBmcm9tICcuLi91dGlsL3JlYWQtcGFja2FnZS1qc29uJztcbmltcG9ydCByZXNvbHZlRGlyIGZyb20gJy4uL3V0aWwvcmVzb2x2ZS1kaXInO1xuaW1wb3J0IFB1Ymxpc2hTdGF0ZSBmcm9tICcuLi91dGlsL3B1Ymxpc2gtc3RhdGUnO1xuaW1wb3J0IGdldEN1cnJlbnRPdXREaXIgZnJvbSAnLi4vdXRpbC9vdXQtZGlyJztcblxuaW1wb3J0IG1ha2UsIHsgTWFrZU9wdGlvbnMgfSBmcm9tICcuL21ha2UnO1xuaW1wb3J0IHJlcXVpcmVTZWFyY2ggZnJvbSAnLi4vdXRpbC9yZXF1aXJlLXNlYXJjaCc7XG5cbmNvbnN0IGQgPSBkZWJ1ZygnZWxlY3Ryb24tZm9yZ2U6cHVibGlzaCcpO1xuXG5leHBvcnQgaW50ZXJmYWNlIFB1Ymxpc2hPcHRpb25zIHtcbiAgLyoqXG4gICAqIFRoZSBwYXRoIHRvIHRoZSBhcHAgdG8gYmUgcHVibGlzaGVkXG4gICAqL1xuICBkaXI/OiBzdHJpbmc7XG4gIC8qKlxuICAgKiBXaGV0aGVyIHRvIHVzZSBzZW5zaWJsZSBkZWZhdWx0cyBvciBwcm9tcHQgdGhlIHVzZXIgdmlzdWFsbHlcbiAgICovXG4gIGludGVyYWN0aXZlPzogYm9vbGVhbjtcbiAgLyoqXG4gICAqIFRoZSBwdWJsaXNoIHRhcmdldHMsIGJ5IGRlZmF1bHQgcHVsbGVkIGZyb20gZm9yZ2UgY29uZmlnLCBzZXQgdGhpcyBwcm9wIHRvXG4gICAqIG92ZXJyaWRlIHRoYXQgbGlzdFxuICAgKi9cbiAgcHVibGlzaFRhcmdldHM/OiAoSUZvcmdlUmVzb2x2YWJsZVB1Ymxpc2hlciB8IElGb3JnZVB1Ymxpc2hlciB8IHN0cmluZylbXTtcbiAgLyoqXG4gICAqIE9wdGlvbnMgb2JqZWN0IHRvIHBhc3NlZCB0aHJvdWdoIHRvIG1ha2UoKVxuICAgKi9cbiAgbWFrZU9wdGlvbnM/OiBNYWtlT3B0aW9ucztcbiAgLyoqXG4gICAqIFRoZSBwYXRoIHRvIHRoZSBkaXJlY3RvcnkgY29udGFpbmluZyBnZW5lcmF0ZWQgZGlzdHJpYnV0YWJsZXNcbiAgICovXG4gIG91dERpcj86IHN0cmluZztcbiAgLyoqXG4gICAqIFdoZXRoZXIgdG8gZ2VuZXJhdGUgZHJ5IHJ1biBtZXRhIGRhdGEgYnV0IG5vdCBhY3R1YWxseSBwdWJsaXNoXG4gICAqL1xuICBkcnlSdW4/OiBib29sZWFuO1xuICAvKipcbiAgICogV2hldGhlciBvciBub3QgdG8gYXR0ZW1wdCB0byByZXN1bWUgYSBwcmV2aW91c2x5IHNhdmVkIGBkcnlSdW5gIGFuZCBwdWJsaXNoXG4gICAqXG4gICAqIFlvdSBjYW4ndCB1c2UgdGhpcyBjb21iaW5hdGlvbiBhdCB0aGUgc2FtZSB0aW1lIGFzIGRyeVJ1bj10cnVlXG4gICAqL1xuICBkcnlSdW5SZXN1bWU/OiBib29sZWFuO1xuICAvKipcbiAgICogUHJvdmlkZSByZXN1bHRzIGZyb20gbWFrZSBzbyB0aGF0IHRoZSBwdWJsaXNoIHN0ZXAgZG9lc24ndCBydW4gbWFrZSBpdHNlbGZcbiAgICovXG4gIG1ha2VSZXN1bHRzPzogRm9yZ2VNYWtlUmVzdWx0W107XG59XG5cbmNvbnN0IHB1Ymxpc2ggPSBhc3luYyAoe1xuICBkaXIgPSBwcm9jZXNzLmN3ZCgpLFxuICBpbnRlcmFjdGl2ZSA9IGZhbHNlLFxuICBtYWtlT3B0aW9ucyA9IHt9LFxuICBwdWJsaXNoVGFyZ2V0cyA9IHVuZGVmaW5lZCxcbiAgZHJ5UnVuID0gZmFsc2UsXG4gIGRyeVJ1blJlc3VtZSA9IGZhbHNlLFxuICBtYWtlUmVzdWx0cyA9IHVuZGVmaW5lZCxcbiAgb3V0RGlyLFxufTogUHVibGlzaE9wdGlvbnMpID0+IHtcbiAgYXN5bmNPcmEuaW50ZXJhY3RpdmUgPSBpbnRlcmFjdGl2ZTtcblxuICBpZiAoZHJ5UnVuICYmIGRyeVJ1blJlc3VtZSkge1xuICAgIHRocm93ICdDYW5cXCd0IGRyeSBydW4gYW5kIHJlc3VtZSBhIGRyeSBydW4gYXQgdGhlIHNhbWUgdGltZSc7XG4gIH1cbiAgaWYgKGRyeVJ1blJlc3VtZSAmJiBtYWtlUmVzdWx0cykge1xuICAgIHRocm93ICdDYW5cXCd0IHJlc3VtZSBhIGRyeSBydW4gYW5kIHVzZSB0aGUgcHJvdmlkZWQgbWFrZVJlc3VsdHMgYXQgdGhlIHNhbWUgdGltZSc7XG4gIH1cblxuICBjb25zdCBmb3JnZUNvbmZpZyA9IGF3YWl0IGdldEZvcmdlQ29uZmlnKGRpcik7XG4gIGxldCBwYWNrYWdlSlNPTiA9IGF3YWl0IHJlYWRNdXRhdGVkUGFja2FnZUpzb24oZGlyLCBmb3JnZUNvbmZpZyk7XG5cbiAgY29uc3QgY2FsY3VsYXRlZE91dERpciA9IG91dERpciB8fCBnZXRDdXJyZW50T3V0RGlyKGRpciwgZm9yZ2VDb25maWcpO1xuICBjb25zdCBkcnlSdW5EaXIgPSBwYXRoLnJlc29sdmUoY2FsY3VsYXRlZE91dERpciwgJ3B1Ymxpc2gtZHJ5LXJ1bicpO1xuXG4gIGlmIChkcnlSdW5SZXN1bWUpIHtcbiAgICBkKCdhdHRlbXB0aW5nIHRvIHJlc3VtZSBmcm9tIGRyeSBydW4nKTtcbiAgICBjb25zdCBwdWJsaXNoZXMgPSBhd2FpdCBQdWJsaXNoU3RhdGUubG9hZEZyb21EaXJlY3RvcnkoZHJ5UnVuRGlyLCBkaXIpO1xuICAgIGZvciAoY29uc3QgcHVibGlzaFN0YXRlcyBvZiBwdWJsaXNoZXMpIHtcbiAgICAgIGQoJ3B1Ymxpc2hpbmcgZm9yIGdpdmVuIHN0YXRlIHNldCcpO1xuICAgICAgYXdhaXQgcHVibGlzaCh7XG4gICAgICAgIGRpcixcbiAgICAgICAgaW50ZXJhY3RpdmUsXG4gICAgICAgIHB1Ymxpc2hUYXJnZXRzLFxuICAgICAgICBtYWtlT3B0aW9ucyxcbiAgICAgICAgZHJ5UnVuOiBmYWxzZSxcbiAgICAgICAgZHJ5UnVuUmVzdW1lOiBmYWxzZSxcbiAgICAgICAgbWFrZVJlc3VsdHM6IHB1Ymxpc2hTdGF0ZXMubWFwKCh7IHN0YXRlIH0pID0+IHN0YXRlKSxcbiAgICAgIH0pO1xuICAgIH1cbiAgICByZXR1cm47XG4gIH1cblxuICBpZiAoIW1ha2VSZXN1bHRzKSB7XG4gICAgZCgndHJpZ2dlcmluZyBtYWtlJyk7XG4gICAgbWFrZVJlc3VsdHMgPSBhd2FpdCBtYWtlKE9iamVjdC5hc3NpZ24oe1xuICAgICAgZGlyLFxuICAgICAgaW50ZXJhY3RpdmUsXG4gICAgfSwgbWFrZU9wdGlvbnMpKTtcbiAgfSBlbHNlIHtcbiAgICAvLyBSZXN0b3JlIHZhbHVlcyBmcm9tIGRyeSBydW5cbiAgICBkKCdyZXN0b3JpbmcgcHVibGlzaCBzZXR0aW5ncyBmcm9tIGRyeSBydW4nKTtcblxuICAgIGZvciAoY29uc3QgbWFrZVJlc3VsdCBvZiBtYWtlUmVzdWx0cykge1xuICAgICAgcGFja2FnZUpTT04gPSBtYWtlUmVzdWx0LnBhY2thZ2VKU09OO1xuICAgICAgbWFrZU9wdGlvbnMucGxhdGZvcm0gPSBtYWtlUmVzdWx0LnBsYXRmb3JtO1xuICAgICAgbWFrZU9wdGlvbnMuYXJjaCA9IG1ha2VSZXN1bHQuYXJjaDtcblxuICAgICAgZm9yIChjb25zdCBtYWtlUGF0aCBvZiBtYWtlUmVzdWx0LmFydGlmYWN0cykge1xuICAgICAgICBpZiAoIWF3YWl0IGZzLnBhdGhFeGlzdHMobWFrZVBhdGgpKSB7XG4gICAgICAgICAgdGhyb3cgYEF0dGVtcHRlZCB0byByZXN1bWUgYSBkcnkgcnVuIGJ1dCBhbiBhcnRpZmFjdCAoJHttYWtlUGF0aH0pIGNvdWxkIG5vdCBiZSBmb3VuZGA7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBpZiAoZHJ5UnVuKSB7XG4gICAgZCgnc2F2aW5nIHJlc3VsdHMgb2YgbWFrZSBpbiBkcnkgcnVuIHN0YXRlJywgbWFrZVJlc3VsdHMpO1xuICAgIGF3YWl0IGZzLnJlbW92ZShkcnlSdW5EaXIpO1xuICAgIGF3YWl0IFB1Ymxpc2hTdGF0ZS5zYXZlVG9EaXJlY3RvcnkoZHJ5UnVuRGlyLCBtYWtlUmVzdWx0cywgZGlyKTtcbiAgICByZXR1cm47XG4gIH1cblxuICBjb25zdCByZXNvbHZlZERpciA9IGF3YWl0IHJlc29sdmVEaXIoZGlyKTtcbiAgaWYgKCFyZXNvbHZlZERpcikge1xuICAgIHRocm93ICdGYWlsZWQgdG8gbG9jYXRlIHB1Ymxpc2hhYmxlIEVsZWN0cm9uIGFwcGxpY2F0aW9uJztcbiAgfVxuICBkaXIgPSByZXNvbHZlZERpcjtcblxuICBjb25zdCB0ZXN0UGxhdGZvcm0gPSBtYWtlT3B0aW9ucy5wbGF0Zm9ybSB8fCBwcm9jZXNzLnBsYXRmb3JtIGFzIEZvcmdlUGxhdGZvcm07XG4gIGlmICghcHVibGlzaFRhcmdldHMpIHtcbiAgICBwdWJsaXNoVGFyZ2V0cyA9IChmb3JnZUNvbmZpZy5wdWJsaXNoZXJzIHx8IFtdKTtcbiAgICAgIC8vIC5maWx0ZXIocHVibGlzaGVyID0+ICh0eXBlb2YgcHVibGlzaGVyICE9PSAnc3RyaW5nJyAmJiBwdWJsaXNoZXIucGxhdGZvcm1zKSA/IHB1Ymxpc2hlci5wbGF0Zm9ybXMuaW5kZXhPZih0ZXN0UGxhdGZvcm0pICE9PSAtMSA6IHRydWUpO1xuICB9XG4gIHB1Ymxpc2hUYXJnZXRzID0gcHVibGlzaFRhcmdldHMubWFwKCh0YXJnZXQpID0+IHtcbiAgICBpZiAodHlwZW9mIHRhcmdldCA9PT0gJ3N0cmluZycpIHtcbiAgICAgIHJldHVybiAoZm9yZ2VDb25maWcucHVibGlzaGVycyB8fCBbXSkuZmluZCgocCkgPT4ge1xuICAgICAgICBpZiAodHlwZW9mIHAgPT09ICdzdHJpbmcnKSByZXR1cm4gZmFsc2U7XG4gICAgICAgIGlmICgocCBhcyBJRm9yZ2VQdWJsaXNoZXIpLl9faXNFbGVjdHJvbkZvcmdlUHVibGlzaGVyKSByZXR1cm4gZmFsc2U7XG4gICAgICAgIHJldHVybiAocCBhcyBJRm9yZ2VSZXNvbHZhYmxlUHVibGlzaGVyKS5uYW1lID09PSB0YXJnZXQ7XG4gICAgICB9KSB8fCB7IG5hbWU6IHRhcmdldCB9O1xuICAgIH1cbiAgICByZXR1cm4gdGFyZ2V0O1xuICB9KSBhcyAoSUZvcmdlUmVzb2x2YWJsZVB1Ymxpc2hlciB8IElGb3JnZVB1Ymxpc2hlcilbXTtcblxuICBmb3IgKGNvbnN0IHB1Ymxpc2hUYXJnZXQgb2YgcHVibGlzaFRhcmdldHMpIHtcbiAgICBsZXQgcHVibGlzaGVyOiBQdWJsaXNoZXJCYXNlPGFueT47XG4gICAgaWYgKChwdWJsaXNoVGFyZ2V0IGFzIElGb3JnZVB1Ymxpc2hlcikuX19pc0VsZWN0cm9uRm9yZ2VQdWJsaXNoZXIpIHtcbiAgICAgIHB1Ymxpc2hlciA9IHB1Ymxpc2hUYXJnZXQgYXMgYW55O1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCByZXNvbHZhYmxlUHVibGlzaFRhcmdldCA9IHB1Ymxpc2hUYXJnZXQgYXMgSUZvcmdlUmVzb2x2YWJsZVB1Ymxpc2hlcjtcbiAgICAgIGxldCBQdWJsaXNoZXJDbGFzczogYW55O1xuICAgICAgYXdhaXQgYXN5bmNPcmEoYFJlc29sdmluZyBwdWJsaXNoIHRhcmdldDogJHtgJHtyZXNvbHZhYmxlUHVibGlzaFRhcmdldC5uYW1lfWAuY3lhbn1gLCBhc3luYyAoKSA9PiB7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tbG9vcC1mdW5jXG4gICAgICAgIFB1Ymxpc2hlckNsYXNzID0gcmVxdWlyZVNlYXJjaChkaXIsIFtyZXNvbHZhYmxlUHVibGlzaFRhcmdldC5uYW1lXSk7XG4gICAgICAgIGlmICghUHVibGlzaGVyQ2xhc3MpIHtcbiAgICAgICAgICB0aHJvdyBgQ291bGQgbm90IGZpbmQgYSBwdWJsaXNoIHRhcmdldCB3aXRoIHRoZSBuYW1lOiAke3Jlc29sdmFibGVQdWJsaXNoVGFyZ2V0Lm5hbWV9YDtcbiAgICAgICAgfVxuICAgICAgfSk7XG5cbiAgICAgIHB1Ymxpc2hlciA9IG5ldyBQdWJsaXNoZXJDbGFzcyhyZXNvbHZhYmxlUHVibGlzaFRhcmdldC5jb25maWcgfHwge30sIHJlc29sdmFibGVQdWJsaXNoVGFyZ2V0LnBsYXRmb3Jtcyk7XG4gICAgfVxuXG4gICAgYXdhaXQgcHVibGlzaGVyLnB1Ymxpc2goe1xuICAgICAgZGlyLFxuICAgICAgbWFrZVJlc3VsdHMsXG4gICAgICBmb3JnZUNvbmZpZyxcbiAgICB9KTtcbiAgfVxufTtcblxuZXhwb3J0IGRlZmF1bHQgcHVibGlzaDtcbiJdfQ==