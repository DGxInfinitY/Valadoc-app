"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

require("colors");

var _asyncOra = require("@electron-forge/async-ora");

var _debug = _interopRequireDefault(require("debug"));

var _fsExtra = _interopRequireDefault(require("fs-extra"));

var _glob = _interopRequireDefault(require("glob"));

var _path = _interopRequireDefault(require("path"));

var _pify = _interopRequireDefault(require("pify"));

var _electronPackager = _interopRequireDefault(require("electron-packager"));

var _forgeConfig = _interopRequireDefault(require("../util/forge-config"));

var _hook = require("../util/hook");

var _messages = require("../util/messages");

var _readPackageJson = require("../util/read-package-json");

var _rebuild = _interopRequireDefault(require("../util/rebuild"));

var _requireSearch = _interopRequireDefault(require("../util/require-search"));

var _resolveDir = _interopRequireDefault(require("../util/resolve-dir"));

var _outDir = _interopRequireDefault(require("../util/out-dir"));

var _electronVersion = require("../util/electron-version");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function asyncGeneratorStep(gen, resolve, reject, _next, _throw, key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { Promise.resolve(value).then(_next, _throw); } }

function _asyncToGenerator(fn) { return function () { var self = this, args = arguments; return new Promise(function (resolve, reject) { var gen = fn.apply(self, args); function _next(value) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, "next", value); } function _throw(err) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, "throw", err); } _next(undefined); }); }; }

const _require = require('electron-download/lib/arch'),
      hostArch = _require.host;

const d = (0, _debug.default)('electron-forge:packager');

/**
 * Resolves hooks if they are a path to a file (instead of a `Function`).
 */
function resolveHooks(hooks, dir) {
  if (hooks) {
    return hooks.map(hook => typeof hook === 'string' ? (0, _requireSearch.default)(dir, [hook]) : hook);
  }

  return [];
}
/**
 * Runs given hooks sequentially by mapping them to promises and iterating
 * through while awaiting
 */


function sequentialHooks(hooks) {
  return [
  /*#__PURE__*/
  function () {
    var _ref = _asyncToGenerator(function* (...args) {
      const done = args[args.length - 1];
      const passedArgs = args.splice(0, args.length - 1);
      var _iteratorNormalCompletion = true;
      var _didIteratorError = false;
      var _iteratorError = undefined;

      try {
        for (var _iterator = hooks[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
          const hook = _step.value;
          yield (0, _pify.default)(hook)(...passedArgs);
        }
      } catch (err) {
        _didIteratorError = true;
        _iteratorError = err;
      } finally {
        try {
          if (!_iteratorNormalCompletion && _iterator.return != null) {
            _iterator.return();
          }
        } finally {
          if (_didIteratorError) {
            throw _iteratorError;
          }
        }
      }

      done();
    });

    return function () {
      return _ref.apply(this, arguments);
    };
  }()];
}

var _default =
/*#__PURE__*/
function () {
  var _ref2 = _asyncToGenerator(function* ({
    dir = process.cwd(),
    interactive = false,
    arch = hostArch(),
    platform = process.platform,
    outDir
  }) {
    const ora = interactive ? _asyncOra.ora : _asyncOra.fakeOra;
    let prepareSpinner = ora(`Preparing to Package Application for arch: ${(arch === 'all' ? 'ia32' : arch).cyan}`).start();
    let prepareCounter = 0;
    const resolvedDir = yield (0, _resolveDir.default)(dir);

    if (!resolvedDir) {
      throw 'Failed to locate compilable Electron application';
    }

    dir = resolvedDir;
    const forgeConfig = yield (0, _forgeConfig.default)(dir);
    const packageJSON = yield (0, _readPackageJson.readMutatedPackageJson)(dir, forgeConfig);

    if (!packageJSON.main) {
      throw 'packageJSON.main must be set to a valid entry point for your Electron app';
    }

    const calculatedOutDir = outDir || (0, _outDir.default)(dir, forgeConfig);
    let packagerSpinner = null;
    const pruneEnabled = !('prune' in forgeConfig.packagerConfig) || forgeConfig.packagerConfig.prune;
    const afterCopyHooks = [
    /*#__PURE__*/
    function () {
      var _ref3 = _asyncToGenerator(function* (buildPath, electronVersion, pPlatform, pArch, done) {
        if (packagerSpinner) {
          packagerSpinner.succeed();
          prepareCounter += 1;
          prepareSpinner = ora(`Preparing to Package Application for arch: ${(prepareCounter === 2 ? 'armv7l' : 'x64').cyan}`).start();
        }

        const bins = yield (0, _pify.default)(_glob.default)(_path.default.join(buildPath, '**/.bin/**/*'));
        var _iteratorNormalCompletion2 = true;
        var _didIteratorError2 = false;
        var _iteratorError2 = undefined;

        try {
          for (var _iterator2 = bins[Symbol.iterator](), _step2; !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
            const bin = _step2.value;
            yield _fsExtra.default.remove(bin);
          }
        } catch (err) {
          _didIteratorError2 = true;
          _iteratorError2 = err;
        } finally {
          try {
            if (!_iteratorNormalCompletion2 && _iterator2.return != null) {
              _iterator2.return();
            }
          } finally {
            if (_didIteratorError2) {
              throw _iteratorError2;
            }
          }
        }

        done();
      });

      return function (_x2, _x3, _x4, _x5, _x6) {
        return _ref3.apply(this, arguments);
      };
    }(),
    /*#__PURE__*/
    function () {
      var _ref4 = _asyncToGenerator(function* (buildPath, electronVersion, pPlatform, pArch, done) {
        prepareSpinner.succeed();
        yield (0, _hook.runHook)(forgeConfig, 'packageAfterCopy', buildPath, electronVersion, pPlatform, pArch);
        done();
      });

      return function (_x7, _x8, _x9, _x10, _x11) {
        return _ref4.apply(this, arguments);
      };
    }(),
    /*#__PURE__*/
    function () {
      var _ref5 = _asyncToGenerator(function* (buildPath, electronVersion, pPlatform, pArch, done) {
        yield (0, _rebuild.default)(buildPath, electronVersion, pPlatform, pArch, forgeConfig.electronRebuildConfig);
        packagerSpinner = ora('Packaging Application').start();
        done();
      });

      return function (_x12, _x13, _x14, _x15, _x16) {
        return _ref5.apply(this, arguments);
      };
    }()];
    afterCopyHooks.push(
    /*#__PURE__*/
    function () {
      var _ref6 = _asyncToGenerator(function* (buildPath, electronVersion, pPlatform, pArch, done) {
        const copiedPackageJSON = yield (0, _readPackageJson.readMutatedPackageJson)(buildPath, forgeConfig);

        if (copiedPackageJSON.config && copiedPackageJSON.config.forge) {
          delete copiedPackageJSON.config.forge;
        }

        yield _fsExtra.default.writeJson(_path.default.resolve(buildPath, 'package.json'), copiedPackageJSON, {
          spaces: 2
        });
        done();
      });

      return function (_x17, _x18, _x19, _x20, _x21) {
        return _ref6.apply(this, arguments);
      };
    }());
    afterCopyHooks.push(...resolveHooks(forgeConfig.packagerConfig.afterCopy, dir));
    const afterPruneHooks = [];

    if (pruneEnabled) {
      afterPruneHooks.push(...resolveHooks(forgeConfig.packagerConfig.afterPrune, dir));
    }

    afterPruneHooks.push(
    /*#__PURE__*/
    function () {
      var _ref7 = _asyncToGenerator(function* (buildPath, electronVersion, pPlatform, pArch, done) {
        yield (0, _hook.runHook)(forgeConfig, 'packageAfterPrune', buildPath, electronVersion, pPlatform, pArch);
        done();
      });

      return function (_x22, _x23, _x24, _x25, _x26) {
        return _ref7.apply(this, arguments);
      };
    }());
    const afterExtractHooks = [
    /*#__PURE__*/
    function () {
      var _ref8 = _asyncToGenerator(function* (buildPath, electronVersion, pPlatform, pArch, done) {
        yield (0, _hook.runHook)(forgeConfig, 'packageAfterExtract', buildPath, electronVersion, pPlatform, pArch);
        done();
      });

      return function (_x27, _x28, _x29, _x30, _x31) {
        return _ref8.apply(this, arguments);
      };
    }()];
    afterExtractHooks.push(...resolveHooks(forgeConfig.packagerConfig.afterExtract, dir));
    const packageOpts = Object.assign({
      asar: false,
      overwrite: true
    }, forgeConfig.packagerConfig, {
      dir,
      arch,
      platform,
      afterCopy: sequentialHooks(afterCopyHooks),
      afterExtract: sequentialHooks(afterExtractHooks),
      afterPrune: sequentialHooks(afterPruneHooks),
      out: calculatedOutDir,
      electronVersion: yield (0, _electronVersion.getElectronVersion)(dir, packageJSON)
    });
    packageOpts.quiet = true;

    if (packageOpts.all) {
      throw new Error('config.forge.packagerConfig.all is not supported by Electron Forge');
    }

    if (!packageJSON.version && !packageOpts.appVersion) {
      // eslint-disable-next-line max-len
      (0, _messages.warn)(interactive, 'Please set "version" or "config.forge.packagerConfig.appVersion" in your application\'s package.json so auto-updates work properly'.yellow);
    }

    if (packageOpts.prebuiltAsar) {
      throw new Error('config.forge.packagerConfig.prebuiltAsar is not supported by Electron Forge');
    }

    yield (0, _hook.runHook)(forgeConfig, 'generateAssets');
    yield (0, _hook.runHook)(forgeConfig, 'prePackage');
    d('packaging with options', packageOpts);
    yield (0, _electronPackager.default)(packageOpts);
    yield (0, _hook.runHook)(forgeConfig, 'postPackage');
    if (packagerSpinner) packagerSpinner.succeed();
  });

  return function (_x) {
    return _ref2.apply(this, arguments);
  };
}();

exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hcGkvcGFja2FnZS50cyJdLCJuYW1lcyI6WyJyZXF1aXJlIiwiaG9zdEFyY2giLCJob3N0IiwiZCIsInJlc29sdmVIb29rcyIsImhvb2tzIiwiZGlyIiwibWFwIiwiaG9vayIsInNlcXVlbnRpYWxIb29rcyIsImFyZ3MiLCJkb25lIiwibGVuZ3RoIiwicGFzc2VkQXJncyIsInNwbGljZSIsInByb2Nlc3MiLCJjd2QiLCJpbnRlcmFjdGl2ZSIsImFyY2giLCJwbGF0Zm9ybSIsIm91dERpciIsIm9yYSIsInJlYWxPcmEiLCJmYWtlT3JhIiwicHJlcGFyZVNwaW5uZXIiLCJjeWFuIiwic3RhcnQiLCJwcmVwYXJlQ291bnRlciIsInJlc29sdmVkRGlyIiwiZm9yZ2VDb25maWciLCJwYWNrYWdlSlNPTiIsIm1haW4iLCJjYWxjdWxhdGVkT3V0RGlyIiwicGFja2FnZXJTcGlubmVyIiwicHJ1bmVFbmFibGVkIiwicGFja2FnZXJDb25maWciLCJwcnVuZSIsImFmdGVyQ29weUhvb2tzIiwiYnVpbGRQYXRoIiwiZWxlY3Ryb25WZXJzaW9uIiwicFBsYXRmb3JtIiwicEFyY2giLCJzdWNjZWVkIiwiYmlucyIsImdsb2IiLCJwYXRoIiwiam9pbiIsImJpbiIsImZzIiwicmVtb3ZlIiwiZWxlY3Ryb25SZWJ1aWxkQ29uZmlnIiwicHVzaCIsImNvcGllZFBhY2thZ2VKU09OIiwiY29uZmlnIiwiZm9yZ2UiLCJ3cml0ZUpzb24iLCJyZXNvbHZlIiwic3BhY2VzIiwiYWZ0ZXJDb3B5IiwiYWZ0ZXJQcnVuZUhvb2tzIiwiYWZ0ZXJQcnVuZSIsImFmdGVyRXh0cmFjdEhvb2tzIiwiYWZ0ZXJFeHRyYWN0IiwicGFja2FnZU9wdHMiLCJPYmplY3QiLCJhc3NpZ24iLCJhc2FyIiwib3ZlcndyaXRlIiwib3V0IiwicXVpZXQiLCJhbGwiLCJFcnJvciIsInZlcnNpb24iLCJhcHBWZXJzaW9uIiwieWVsbG93IiwicHJlYnVpbHRBc2FyIl0sIm1hcHBpbmdzIjoiOzs7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QUN0QixHIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICdjb2xvcnMnO1xuaW1wb3J0IHsgb3JhIGFzIHJlYWxPcmEsIGZha2VPcmEsIE9yYUltcGwgfSBmcm9tICdAZWxlY3Ryb24tZm9yZ2UvYXN5bmMtb3JhJztcbmltcG9ydCB7IEZvcmdlQXJjaCwgRm9yZ2VQbGF0Zm9ybSwgRm9yZ2VDb25maWcgfSBmcm9tICdAZWxlY3Ryb24tZm9yZ2Uvc2hhcmVkLXR5cGVzJztcbmltcG9ydCBkZWJ1ZyBmcm9tICdkZWJ1Zyc7XG5pbXBvcnQgZnMgZnJvbSAnZnMtZXh0cmEnO1xuaW1wb3J0IGdsb2IgZnJvbSAnZ2xvYic7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBwaWZ5IGZyb20gJ3BpZnknO1xuaW1wb3J0IHBhY2thZ2VyIGZyb20gJ2VsZWN0cm9uLXBhY2thZ2VyJztcblxuaW1wb3J0IGdldEZvcmdlQ29uZmlnIGZyb20gJy4uL3V0aWwvZm9yZ2UtY29uZmlnJztcbmltcG9ydCB7IHJ1bkhvb2sgfSBmcm9tICcuLi91dGlsL2hvb2snO1xuaW1wb3J0IHsgd2FybiB9IGZyb20gJy4uL3V0aWwvbWVzc2FnZXMnO1xuaW1wb3J0IHsgcmVhZE11dGF0ZWRQYWNrYWdlSnNvbiB9IGZyb20gJy4uL3V0aWwvcmVhZC1wYWNrYWdlLWpzb24nO1xuaW1wb3J0IHJlYnVpbGRIb29rIGZyb20gJy4uL3V0aWwvcmVidWlsZCc7XG5pbXBvcnQgcmVxdWlyZVNlYXJjaCBmcm9tICcuLi91dGlsL3JlcXVpcmUtc2VhcmNoJztcbmltcG9ydCByZXNvbHZlRGlyIGZyb20gJy4uL3V0aWwvcmVzb2x2ZS1kaXInO1xuaW1wb3J0IGdldEN1cnJlbnRPdXREaXIgZnJvbSAnLi4vdXRpbC9vdXQtZGlyJztcbmltcG9ydCB7IGdldEVsZWN0cm9uVmVyc2lvbiB9IGZyb20gJy4uL3V0aWwvZWxlY3Ryb24tdmVyc2lvbic7XG5cbmNvbnN0IHsgaG9zdDogaG9zdEFyY2ggfTogeyBob3N0OiAoKSA9PiBGb3JnZUFyY2ggfCAnYWxsJyB9ID0gcmVxdWlyZSgnZWxlY3Ryb24tZG93bmxvYWQvbGliL2FyY2gnKTtcblxuY29uc3QgZCA9IGRlYnVnKCdlbGVjdHJvbi1mb3JnZTpwYWNrYWdlcicpO1xuXG50eXBlIEVsZWN0cm9uUGFja2FnZXJBZnRlckNvcHlIb29rID1cbiAgKGJ1aWxkUGF0aDogc3RyaW5nLCBlbGVjdHJvblZlcnNpb246IHN0cmluZywgcFBsYXRmb3JtOiBGb3JnZVBsYXRmb3JtLCBwQXJjaDogRm9yZ2VBcmNoLCBkb25lOiAoZXJyPzogRXJyb3IpID0+IHZvaWQpID0+IHZvaWQ7XG5cbi8qKlxuICogUmVzb2x2ZXMgaG9va3MgaWYgdGhleSBhcmUgYSBwYXRoIHRvIGEgZmlsZSAoaW5zdGVhZCBvZiBhIGBGdW5jdGlvbmApLlxuICovXG5mdW5jdGlvbiByZXNvbHZlSG9va3MoaG9va3M6IChzdHJpbmcgfCBFbGVjdHJvblBhY2thZ2VyQWZ0ZXJDb3B5SG9vaylbXSB8IHVuZGVmaW5lZCwgZGlyOiBzdHJpbmcpIHtcbiAgaWYgKGhvb2tzKSB7XG4gICAgcmV0dXJuIGhvb2tzLm1hcChob29rID0+IChcbiAgICAgIHR5cGVvZiBob29rID09PSAnc3RyaW5nJ1xuICAgICAgPyByZXF1aXJlU2VhcmNoPEVsZWN0cm9uUGFja2FnZXJBZnRlckNvcHlIb29rPihkaXIsIFtob29rXSkgYXMgRWxlY3Ryb25QYWNrYWdlckFmdGVyQ29weUhvb2tcbiAgICAgIDogaG9va1xuICAgICkpO1xuICB9XG5cbiAgcmV0dXJuIFtdO1xufVxuXG4vKipcbiAqIFJ1bnMgZ2l2ZW4gaG9va3Mgc2VxdWVudGlhbGx5IGJ5IG1hcHBpbmcgdGhlbSB0byBwcm9taXNlcyBhbmQgaXRlcmF0aW5nXG4gKiB0aHJvdWdoIHdoaWxlIGF3YWl0aW5nXG4gKi9cbmZ1bmN0aW9uIHNlcXVlbnRpYWxIb29rcyhob29rczogRnVuY3Rpb25bXSkge1xuICByZXR1cm4gW2FzeW5jICguLi5hcmdzOiBhbnlbXSkgPT4ge1xuICAgIGNvbnN0IGRvbmUgPSBhcmdzW2FyZ3MubGVuZ3RoIC0gMV07XG4gICAgY29uc3QgcGFzc2VkQXJncyA9IGFyZ3Muc3BsaWNlKDAsIGFyZ3MubGVuZ3RoIC0gMSk7XG4gICAgZm9yIChjb25zdCBob29rIG9mIGhvb2tzKSB7XG4gICAgICBhd2FpdCBwaWZ5KGhvb2spKC4uLnBhc3NlZEFyZ3MpO1xuICAgIH1cbiAgICBkb25lKCk7XG4gIH1dIGFzIFsoLi4uYXJnczogYW55W10pID0+IFByb21pc2U8dm9pZD5dO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFBhY2thZ2VPcHRpb25zIHtcbiAgLyoqXG4gICAqIFRoZSBwYXRoIHRvIHRoZSBhcHAgdG8gcGFja2FnZVxuICAgKi9cbiAgZGlyPzogc3RyaW5nO1xuICAvKipcbiAgICogV2hldGhlciB0byB1c2Ugc2Vuc2libGUgZGVmYXVsdHMgb3IgcHJvbXB0IHRoZSB1c2VyIHZpc3VhbGx5XG4gICAqL1xuICBpbnRlcmFjdGl2ZT86IGJvb2xlYW47XG4gIC8qKlxuICAgKiBUaGUgdGFyZ2V0IGFyY2hcbiAgICovXG4gIGFyY2g/OiBGb3JnZUFyY2g7XG4gIC8qKlxuICAgKiBUaGUgdGFyZ2V0IHBsYXRmb3JtLlxuICAgKi9cbiAgcGxhdGZvcm0/OiBGb3JnZVBsYXRmb3JtO1xuICAvKipcbiAgICogVGhlIHBhdGggdG8gdGhlIG91dHB1dCBkaXJlY3RvcnkgZm9yIHBhY2thZ2VkIGFwcHNcbiAgICovXG4gIG91dERpcj86IHN0cmluZztcbn1cblxuZXhwb3J0IGRlZmF1bHQgYXN5bmMgKHtcbiAgZGlyID0gcHJvY2Vzcy5jd2QoKSxcbiAgaW50ZXJhY3RpdmUgPSBmYWxzZSxcbiAgYXJjaCA9IGhvc3RBcmNoKCksXG4gIHBsYXRmb3JtID0gcHJvY2Vzcy5wbGF0Zm9ybSBhcyBGb3JnZVBsYXRmb3JtLFxuICBvdXREaXIsXG59OiBQYWNrYWdlT3B0aW9ucykgPT4ge1xuICBjb25zdCBvcmEgPSBpbnRlcmFjdGl2ZSA/IHJlYWxPcmEgOiBmYWtlT3JhO1xuXG4gIGxldCBwcmVwYXJlU3Bpbm5lciA9IG9yYShgUHJlcGFyaW5nIHRvIFBhY2thZ2UgQXBwbGljYXRpb24gZm9yIGFyY2g6ICR7KGFyY2ggPT09ICdhbGwnID8gJ2lhMzInIDogYXJjaCkuY3lhbn1gKS5zdGFydCgpO1xuICBsZXQgcHJlcGFyZUNvdW50ZXIgPSAwO1xuXG4gIGNvbnN0IHJlc29sdmVkRGlyID0gYXdhaXQgcmVzb2x2ZURpcihkaXIpO1xuICBpZiAoIXJlc29sdmVkRGlyKSB7XG4gICAgdGhyb3cgJ0ZhaWxlZCB0byBsb2NhdGUgY29tcGlsYWJsZSBFbGVjdHJvbiBhcHBsaWNhdGlvbic7XG4gIH1cbiAgZGlyID0gcmVzb2x2ZWREaXI7XG5cbiAgY29uc3QgZm9yZ2VDb25maWcgPSBhd2FpdCBnZXRGb3JnZUNvbmZpZyhkaXIpO1xuICBjb25zdCBwYWNrYWdlSlNPTiA9IGF3YWl0IHJlYWRNdXRhdGVkUGFja2FnZUpzb24oZGlyLCBmb3JnZUNvbmZpZyk7XG5cbiAgaWYgKCFwYWNrYWdlSlNPTi5tYWluKSB7XG4gICAgdGhyb3cgJ3BhY2thZ2VKU09OLm1haW4gbXVzdCBiZSBzZXQgdG8gYSB2YWxpZCBlbnRyeSBwb2ludCBmb3IgeW91ciBFbGVjdHJvbiBhcHAnO1xuICB9XG5cbiAgY29uc3QgY2FsY3VsYXRlZE91dERpciA9IG91dERpciB8fCBnZXRDdXJyZW50T3V0RGlyKGRpciwgZm9yZ2VDb25maWcpO1xuICBsZXQgcGFja2FnZXJTcGlubmVyOiBPcmFJbXBsIHwgbnVsbCA9IG51bGw7XG5cbiAgY29uc3QgcHJ1bmVFbmFibGVkID0gISgncHJ1bmUnIGluIGZvcmdlQ29uZmlnLnBhY2thZ2VyQ29uZmlnKSB8fCBmb3JnZUNvbmZpZy5wYWNrYWdlckNvbmZpZy5wcnVuZTtcblxuICBjb25zdCBhZnRlckNvcHlIb29rczogRWxlY3Ryb25QYWNrYWdlckFmdGVyQ29weUhvb2tbXSA9IFtcbiAgICBhc3luYyAoYnVpbGRQYXRoLCBlbGVjdHJvblZlcnNpb24sIHBQbGF0Zm9ybSwgcEFyY2gsIGRvbmUpID0+IHtcbiAgICAgIGlmIChwYWNrYWdlclNwaW5uZXIpIHtcbiAgICAgICAgcGFja2FnZXJTcGlubmVyLnN1Y2NlZWQoKTtcbiAgICAgICAgcHJlcGFyZUNvdW50ZXIgKz0gMTtcbiAgICAgICAgcHJlcGFyZVNwaW5uZXIgPSBvcmEoYFByZXBhcmluZyB0byBQYWNrYWdlIEFwcGxpY2F0aW9uIGZvciBhcmNoOiAkeyhwcmVwYXJlQ291bnRlciA9PT0gMiA/ICdhcm12N2wnIDogJ3g2NCcpLmN5YW59YCkuc3RhcnQoKTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IGJpbnMgPSBhd2FpdCBwaWZ5KGdsb2IpKHBhdGguam9pbihidWlsZFBhdGgsICcqKi8uYmluLyoqLyonKSk7XG4gICAgICBmb3IgKGNvbnN0IGJpbiBvZiBiaW5zKSB7XG4gICAgICAgIGF3YWl0IGZzLnJlbW92ZShiaW4pO1xuICAgICAgfVxuICAgICAgZG9uZSgpO1xuICAgIH0sIGFzeW5jIChidWlsZFBhdGgsIGVsZWN0cm9uVmVyc2lvbiwgcFBsYXRmb3JtLCBwQXJjaCwgZG9uZSkgPT4ge1xuICAgICAgcHJlcGFyZVNwaW5uZXIuc3VjY2VlZCgpO1xuICAgICAgYXdhaXQgcnVuSG9vayhmb3JnZUNvbmZpZywgJ3BhY2thZ2VBZnRlckNvcHknLCBidWlsZFBhdGgsIGVsZWN0cm9uVmVyc2lvbiwgcFBsYXRmb3JtLCBwQXJjaCk7XG4gICAgICBkb25lKCk7XG4gICAgfSxcbiAgICBhc3luYyAoYnVpbGRQYXRoLCBlbGVjdHJvblZlcnNpb24sIHBQbGF0Zm9ybSwgcEFyY2gsIGRvbmUpID0+IHtcbiAgICAgIGF3YWl0IHJlYnVpbGRIb29rKGJ1aWxkUGF0aCwgZWxlY3Ryb25WZXJzaW9uLCBwUGxhdGZvcm0sIHBBcmNoLCBmb3JnZUNvbmZpZy5lbGVjdHJvblJlYnVpbGRDb25maWcpO1xuICAgICAgcGFja2FnZXJTcGlubmVyID0gb3JhKCdQYWNrYWdpbmcgQXBwbGljYXRpb24nKS5zdGFydCgpO1xuICAgICAgZG9uZSgpO1xuICAgIH0sXG4gIF07XG5cbiAgYWZ0ZXJDb3B5SG9va3MucHVzaChhc3luYyAoYnVpbGRQYXRoLCBlbGVjdHJvblZlcnNpb24sIHBQbGF0Zm9ybSwgcEFyY2gsIGRvbmUpID0+IHtcbiAgICBjb25zdCBjb3BpZWRQYWNrYWdlSlNPTiA9IGF3YWl0IHJlYWRNdXRhdGVkUGFja2FnZUpzb24oYnVpbGRQYXRoLCBmb3JnZUNvbmZpZyk7XG4gICAgaWYgKGNvcGllZFBhY2thZ2VKU09OLmNvbmZpZyAmJiBjb3BpZWRQYWNrYWdlSlNPTi5jb25maWcuZm9yZ2UpIHtcbiAgICAgIGRlbGV0ZSBjb3BpZWRQYWNrYWdlSlNPTi5jb25maWcuZm9yZ2U7XG4gICAgfVxuICAgIGF3YWl0IGZzLndyaXRlSnNvbihwYXRoLnJlc29sdmUoYnVpbGRQYXRoLCAncGFja2FnZS5qc29uJyksIGNvcGllZFBhY2thZ2VKU09OLCB7IHNwYWNlczogMiB9KTtcbiAgICBkb25lKCk7XG4gIH0pO1xuXG4gIGFmdGVyQ29weUhvb2tzLnB1c2goLi4ucmVzb2x2ZUhvb2tzKGZvcmdlQ29uZmlnLnBhY2thZ2VyQ29uZmlnLmFmdGVyQ29weSwgZGlyKSk7XG5cbiAgY29uc3QgYWZ0ZXJQcnVuZUhvb2tzID0gW107XG5cbiAgaWYgKHBydW5lRW5hYmxlZCkge1xuICAgIGFmdGVyUHJ1bmVIb29rcy5wdXNoKC4uLnJlc29sdmVIb29rcyhmb3JnZUNvbmZpZy5wYWNrYWdlckNvbmZpZy5hZnRlclBydW5lLCBkaXIpKTtcbiAgfVxuXG4gIGFmdGVyUHJ1bmVIb29rcy5wdXNoKChhc3luYyAoYnVpbGRQYXRoLCBlbGVjdHJvblZlcnNpb24sIHBQbGF0Zm9ybSwgcEFyY2gsIGRvbmUpID0+IHtcbiAgICBhd2FpdCBydW5Ib29rKGZvcmdlQ29uZmlnLCAncGFja2FnZUFmdGVyUHJ1bmUnLCBidWlsZFBhdGgsIGVsZWN0cm9uVmVyc2lvbiwgcFBsYXRmb3JtLCBwQXJjaCk7XG4gICAgZG9uZSgpO1xuICB9KSBhcyBFbGVjdHJvblBhY2thZ2VyQWZ0ZXJDb3B5SG9vayk7XG5cbiAgY29uc3QgYWZ0ZXJFeHRyYWN0SG9va3MgPSBbKGFzeW5jIChidWlsZFBhdGgsIGVsZWN0cm9uVmVyc2lvbiwgcFBsYXRmb3JtLCBwQXJjaCwgZG9uZSkgPT4ge1xuICAgIGF3YWl0IHJ1bkhvb2soZm9yZ2VDb25maWcsICdwYWNrYWdlQWZ0ZXJFeHRyYWN0JywgYnVpbGRQYXRoLCBlbGVjdHJvblZlcnNpb24sIHBQbGF0Zm9ybSwgcEFyY2gpO1xuICAgIGRvbmUoKTtcbiAgfSkgYXMgRWxlY3Ryb25QYWNrYWdlckFmdGVyQ29weUhvb2tdO1xuICBhZnRlckV4dHJhY3RIb29rcy5wdXNoKC4uLnJlc29sdmVIb29rcyhmb3JnZUNvbmZpZy5wYWNrYWdlckNvbmZpZy5hZnRlckV4dHJhY3QsIGRpcikpO1xuXG4gIGNvbnN0IHBhY2thZ2VPcHRzOiBwYWNrYWdlci5PcHRpb25zID0gT2JqZWN0LmFzc2lnbih7XG4gICAgYXNhcjogZmFsc2UsXG4gICAgb3ZlcndyaXRlOiB0cnVlLFxuICB9LCBmb3JnZUNvbmZpZy5wYWNrYWdlckNvbmZpZywge1xuICAgIGRpcixcbiAgICBhcmNoLFxuICAgIHBsYXRmb3JtLFxuICAgIGFmdGVyQ29weTogc2VxdWVudGlhbEhvb2tzKGFmdGVyQ29weUhvb2tzKSxcbiAgICBhZnRlckV4dHJhY3Q6IHNlcXVlbnRpYWxIb29rcyhhZnRlckV4dHJhY3RIb29rcyksXG4gICAgYWZ0ZXJQcnVuZTogc2VxdWVudGlhbEhvb2tzKGFmdGVyUHJ1bmVIb29rcyksXG4gICAgb3V0OiBjYWxjdWxhdGVkT3V0RGlyLFxuICAgIGVsZWN0cm9uVmVyc2lvbjogYXdhaXQgZ2V0RWxlY3Ryb25WZXJzaW9uKGRpciwgcGFja2FnZUpTT04pLFxuICB9KTtcbiAgcGFja2FnZU9wdHMucXVpZXQgPSB0cnVlO1xuXG4gIGlmIChwYWNrYWdlT3B0cy5hbGwpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ2NvbmZpZy5mb3JnZS5wYWNrYWdlckNvbmZpZy5hbGwgaXMgbm90IHN1cHBvcnRlZCBieSBFbGVjdHJvbiBGb3JnZScpO1xuICB9XG5cbiAgaWYgKCFwYWNrYWdlSlNPTi52ZXJzaW9uICYmICFwYWNrYWdlT3B0cy5hcHBWZXJzaW9uKSB7XG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG1heC1sZW5cbiAgICB3YXJuKGludGVyYWN0aXZlLCAnUGxlYXNlIHNldCBcInZlcnNpb25cIiBvciBcImNvbmZpZy5mb3JnZS5wYWNrYWdlckNvbmZpZy5hcHBWZXJzaW9uXCIgaW4geW91ciBhcHBsaWNhdGlvblxcJ3MgcGFja2FnZS5qc29uIHNvIGF1dG8tdXBkYXRlcyB3b3JrIHByb3Blcmx5Jy55ZWxsb3cpO1xuICB9XG5cbiAgaWYgKHBhY2thZ2VPcHRzLnByZWJ1aWx0QXNhcikge1xuICAgIHRocm93IG5ldyBFcnJvcignY29uZmlnLmZvcmdlLnBhY2thZ2VyQ29uZmlnLnByZWJ1aWx0QXNhciBpcyBub3Qgc3VwcG9ydGVkIGJ5IEVsZWN0cm9uIEZvcmdlJyk7XG4gIH1cblxuICBhd2FpdCBydW5Ib29rKGZvcmdlQ29uZmlnLCAnZ2VuZXJhdGVBc3NldHMnKTtcbiAgYXdhaXQgcnVuSG9vayhmb3JnZUNvbmZpZywgJ3ByZVBhY2thZ2UnKTtcblxuICBkKCdwYWNrYWdpbmcgd2l0aCBvcHRpb25zJywgcGFja2FnZU9wdHMpO1xuXG4gIGF3YWl0IHBhY2thZ2VyKHBhY2thZ2VPcHRzKTtcblxuICBhd2FpdCBydW5Ib29rKGZvcmdlQ29uZmlnLCAncG9zdFBhY2thZ2UnKTtcblxuICBpZiAocGFja2FnZXJTcGlubmVyKSBwYWNrYWdlclNwaW5uZXIhLnN1Y2NlZWQoKTtcbn07XG4iXX0=